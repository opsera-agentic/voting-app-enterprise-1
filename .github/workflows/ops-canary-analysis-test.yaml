name: "ops: Canary Analysis Test"

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "Analysis provider (newrelic, prometheus, http)"
        required: true
        default: "newrelic"
  push:
    paths:
      - ".github/canary-test-config.txt"

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  switch-and-deploy:
    name: "Canary Analysis Test"
    runs-on: ubuntu-latest
    outputs:
      provider: ${{ steps.provider.outputs.value }}
      template: ${{ steps.template.outputs.name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Get Provider
        id: provider
        run: |
          if [ -n "${{ inputs.provider }}" ]; then
            PROVIDER="${{ inputs.provider }}"
          else
            # Read first word only, ignore comments and whitespace
            PROVIDER=$(cat .github/canary-test-config.txt 2>/dev/null | awk '{print $1}' | head -1 || echo "newrelic")
          fi
          # Validate provider
          case "$PROVIDER" in
            newrelic|prometheus|http) ;;
            *) PROVIDER="http" ;;
          esac
          echo "value=$PROVIDER" >> $GITHUB_OUTPUT
          echo "Using provider: $PROVIDER"

      - name: Determine Template
        id: template
        run: |
          PROVIDER="${{ steps.provider.outputs.value }}"
          case "$PROVIDER" in
            newrelic)
              # Use Job-based template that properly handles secrets
              echo "name=newrelic-job-analysis" >> $GITHUB_OUTPUT
              ;;
            prometheus)
              echo "name=success-rate" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=http-health-check" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Update Rollout Config
        run: |
          PROVIDER="${{ steps.provider.outputs.value }}"
          TEMPLATE="${{ steps.template.outputs.name }}"
          
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Provider: **$PROVIDER**" >> $GITHUB_STEP_SUMMARY
          echo "- Template: **$TEMPLATE**" >> $GITHUB_STEP_SUMMARY
          
          # Update patch file using Python for cleaner YAML generation
          python3 << PYEOF
          import yaml
          
          provider = "$PROVIDER"
          template = "$TEMPLATE"
          
          if provider == "newrelic":
              # Job-based template with proper secret handling
              vote_args = [
                  {"name": "app-name", "value": "vote"},
                  {"name": "error-threshold", "value": "5"},
                  {"name": "latency-threshold", "value": "500"},
                  {"name": "apdex-threshold", "value": "0.85"},
                  {"name": "nr-api-url", "value": "https://opsera-nrmock-labs.agent.opsera.dev"}
              ]
              result_args = [
                  {"name": "app-name", "value": "result"},
                  {"name": "error-threshold", "value": "5"},
                  {"name": "latency-threshold", "value": "500"},
                  {"name": "apdex-threshold", "value": "0.85"},
                  {"name": "nr-api-url", "value": "https://opsera-nrmock-labs.agent.opsera.dev"}
              ]
          elif provider == "prometheus":
              vote_args = [
                  {"name": "service-name", "value": "vote"},
                  {"name": "ingress-name", "value": "voting-app"}
              ]
              result_args = [
                  {"name": "service-name", "value": "result"},
                  {"name": "ingress-name", "value": "voting-app-result"}
              ]
          else:
              vote_args = [
                  {"name": "service-name", "value": "vote"},
                  {"name": "namespace", "value": "voting-app-qa"}
              ]
              result_args = [
                  {"name": "service-name", "value": "result"},
                  {"name": "namespace", "value": "voting-app-qa"}
              ]
          
          docs = [
              {
                  "apiVersion": "argoproj.io/v1alpha1",
                  "kind": "Rollout",
                  "metadata": {"name": "vote-rollout"},
                  "spec": {
                      "replicas": 4,
                      "strategy": {
                          "canary": {
                              "steps": [
                                  {"setWeight": 10},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 30},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 60},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 100}
                              ],
                              "analysis": {
                                  "templates": [{"templateName": template}],
                                  "startingStep": 1,
                                  "args": vote_args
                              },
                              "trafficRouting": {
                                  "nginx": {
                                      "stableIngress": "voting-app",
                                      "annotationPrefix": "nginx.ingress.kubernetes.io"
                                  }
                              }
                          }
                      }
                  }
              },
              {
                  "apiVersion": "argoproj.io/v1alpha1",
                  "kind": "Rollout",
                  "metadata": {"name": "result-rollout"},
                  "spec": {
                      "replicas": 3,
                      "strategy": {
                          "canary": {
                              "steps": [
                                  {"setWeight": 10},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 30},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 60},
                                  {"pause": {"duration": "1m"}},
                                  {"setWeight": 100}
                              ],
                              "analysis": {
                                  "templates": [{"templateName": template}],
                                  "startingStep": 1,
                                  "args": result_args
                              },
                              "trafficRouting": {
                                  "nginx": {
                                      "stableIngress": "voting-app-result",
                                      "annotationPrefix": "nginx.ingress.kubernetes.io"
                                  }
                              }
                          }
                      }
                  }
              },
              {
                  "apiVersion": "apps/v1",
                  "kind": "Deployment",
                  "metadata": {"name": "worker"},
                  "spec": {"replicas": 2}
              }
          ]
          
          with open(".opsera-voting-app/k8s/overlays/qa/patch-rollout-replicas.yaml", "w") as f:
              f.write(f"# QA - Testing {provider} canary analysis\n")
              yaml.dump_all(docs, f, default_flow_style=False)
          
          print(f"Updated patch file for {provider}")
          PYEOF

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "test(${{ steps.provider.outputs.value }}): switch canary to ${{ steps.template.outputs.name }}"
          git push origin main || echo "Nothing to push"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Committed" >> $GITHUB_STEP_SUMMARY

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          sleep 5
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"gha"},"sync":{"prune":true}}}' || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Synced" >> $GITHUB_STEP_SUMMARY
          sleep 30

      - name: Restart Rollouts
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl-argo-rollouts restart vote-rollout -n voting-app-qa 2>&1 || true
          kubectl-argo-rollouts restart result-rollout -n voting-app-qa 2>&1 || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollouts Restarted" >> $GITHUB_STEP_SUMMARY

  monitor:
    name: "Monitor Canary"
    runs-on: ubuntu-latest
    needs: [switch-and-deploy]

    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Monitor Rollout
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "## Canary Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "Provider: **${{ needs.switch-and-deploy.outputs.provider }}**" >> $GITHUB_STEP_SUMMARY
          echo "Template: **${{ needs.switch-and-deploy.outputs.template }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 12); do
            echo "### Check $i/12 ($(date +%H:%M:%S))" >> $GITHUB_STEP_SUMMARY
            
            PHASE=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            STEP=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "-")
            WEIGHT=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.canary.weight}' 2>/dev/null || echo "-")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | $PHASE |" >> $GITHUB_STEP_SUMMARY
            echo "| Step | $STEP |" >> $GITHUB_STEP_SUMMARY
            echo "| Weight | ${WEIGHT}% |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Analysis Runs:**" >> $GITHUB_STEP_SUMMARY
            kubectl get analysisruns -n voting-app-qa --sort-by='.metadata.creationTimestamp' 2>/dev/null | tail -5 >> $GITHUB_STEP_SUMMARY || echo "None found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            
            if [ "$PHASE" = "Healthy" ]; then
              echo "## SUCCESS - Rollout Completed!" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ "$PHASE" = "Degraded" ]; then
              echo "## FAILED - Rollout Degraded!" >> $GITHUB_STEP_SUMMARY
              kubectl-argo-rollouts get rollout vote-rollout -n voting-app-qa 2>&1 >> $GITHUB_STEP_SUMMARY || true
              exit 1
            fi
            
            sleep 30
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Final Rollout Status" >> $GITHUB_STEP_SUMMARY
          kubectl-argo-rollouts get rollout vote-rollout -n voting-app-qa 2>&1 >> $GITHUB_STEP_SUMMARY || true
