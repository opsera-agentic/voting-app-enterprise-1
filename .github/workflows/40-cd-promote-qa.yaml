# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                â•‘
# â•‘              ENTERPRISE CD PIPELINE - PROMOTE TO QA                            â•‘
# â•‘                                                                                â•‘
# â•‘  Stage 4 of the CI/CD Pipeline:                                                â•‘
# â•‘  â€¢ Detect current DEV version                                                  â•‘
# â•‘  â€¢ Pre-flight checks (DEV health validation)                                   â•‘
# â•‘  â€¢ Manual approval gate via Slack + GitHub Environment                         â•‘
# â•‘  â€¢ Promote to QA with canary deployment                                        â•‘
# â•‘                                                                                â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "â¬†ï¸ CD: Promote to QA"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote (leave empty to auto-detect from DEV)'
        required: false
        type: string
      skip_approval:
        description: 'Skip approval gate (emergency only)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DETECT VERSION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-version:
    name: "ğŸ” Detect Version"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      commit_hash: ${{ steps.detect.outputs.commit_hash }}
      commit_url: ${{ steps.detect.outputs.commit_url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Detect DEV Version
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            # Extract from DEV kustomization
            IMAGE_TAG=$(grep -A2 "name: vote$" .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/kustomization.yaml | grep "newTag" | awk -F': ' '{print $2}' | tr -d ' "')
          fi
          
          COMMIT_HASH=$(echo "$IMAGE_TAG" | cut -d'-' -f1)
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_HASH}"
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_url=${COMMIT_URL}" >> $GITHUB_OUTPUT
          
          echo "### ğŸ” Version Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [${COMMIT_HASH}](${COMMIT_URL}) |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRE-FLIGHT CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  preflight-check:
    name: "ğŸ” Pre-flight Check"
    runs-on: ubuntu-latest
    needs: [detect-version]
    outputs:
      dev_healthy: ${{ steps.check.outputs.dev_healthy }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Check DEV Health
        id: check
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          HEALTH=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
          SYNC=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
          
          echo "### ğŸ” Pre-flight Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Health | Sync |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          [ "$HEALTH" = "Healthy" ] && H_EMOJI="ğŸŸ¢" || H_EMOJI="ğŸ”´"
          [ "$SYNC" = "Synced" ] && S_EMOJI="âœ…" || S_EMOJI="âš ï¸"
          
          echo "| DEV | ${H_EMOJI} ${HEALTH} | ${S_EMOJI} ${SYNC} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH" = "Healthy" ]; then
            echo "dev_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "dev_healthy=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning:** DEV is not healthy. Promotion may fail." >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SLACK APPROVAL REQUEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  request-approval:
    name: "ğŸ“¨ Request Approval"
    runs-on: ubuntu-latest
    needs: [detect-version, preflight-check]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    
    steps:
      - name: Send Slack Approval Request
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not configured"
            exit 0
          fi
          
          IMAGE_TAG="${{ needs.detect-version.outputs.image_tag }}"
          COMMIT_URL="${{ needs.detect-version.outputs.commit_url }}"
          COMMIT_HASH="${{ needs.detect-version.outputs.commit_hash }}"
          APPROVE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {"type": "header", "text": {"type": "plain_text", "text": "ğŸš¦ QA Promotion Approval Required", "emoji": true}},
                {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${IMAGE_TAG}"'`"},
                  {"type": "mrkdwn", "text": "*Commit:*\n<'"${COMMIT_URL}"'|'"${COMMIT_HASH}"'>"}
                ]},
                {"type": "section", "text": {"type": "mrkdwn", "text": "*Promotion Flow:*\nDEV âœ… â†’ *QA* ğŸ¤ (Canary: 10% â†’ 30% â†’ 60% â†’ 100%)"}},
                {"type": "divider"},
                {"type": "actions", "elements": [
                  {"type": "button", "text": {"type": "plain_text", "text": "âœ… Approve & Deploy"}, "style": "primary", "url": "'"${APPROVE_URL}"'"},
                  {"type": "button", "text": {"type": "plain_text", "text": "ğŸ‘€ View Changes"}, "url": "'"${COMMIT_URL}"'"}
                ]},
                {"type": "context", "elements": [
                  {"type": "mrkdwn", "text": "Requested by *${{ github.actor }}* | <'"${APPROVE_URL}"'|View Workflow>"}
                ]}
              ]
            }' \
            "$SLACK_WEBHOOK"
          
          echo "### ğŸ“¨ Approval Request Sent" >> $GITHUB_STEP_SUMMARY
          echo "Slack notification sent. Waiting for approval..." >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # APPROVAL GATE (GitHub Environment)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  approval-gate:
    name: "ğŸš¦ Approval Gate"
    runs-on: ubuntu-latest
    needs: [detect-version, preflight-check, request-approval]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    environment:
      name: qa-approval
      url: https://opsera-voting-app-qa.agent.opsera.dev
    
    steps:
      - name: Approval Confirmed
        run: |
          echo "### ğŸš¦ Approval Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment to QA approved!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Approved By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.detect-version.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO QA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-qa:
    name: "ğŸš€ Deploy to QA"
    runs-on: ubuntu-latest
    needs: [detect-version, approval-gate]
    if: always() && (needs.approval-gate.result == 'success' || github.event.inputs.skip_approval == 'true')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update QA Manifests
        env:
          IMAGE_TAG: ${{ needs.detect-version.outputs.image_tag }}
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/qa/kustomization.yaml"
          
          # Update image references
          sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"
          
          echo "### ğŸ“ QA Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "Updated with tag: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git diff --staged --quiet || git commit -m "chore(qa): promote ${{ needs.detect-version.outputs.image_tag }} from DEV [skip ci]"
          git push origin main || echo "No changes to push"

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY COMPLETION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-complete:
    name: "ğŸ“¢ Notify"
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-qa]
    if: always()
    
    steps:
      - name: Send Completion Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then exit 0; fi
          
          STATUS="${{ needs.deploy-qa.result }}"
          [ "$STATUS" = "success" ] && EMOJI="âœ…" && COLOR="good" || EMOJI="âŒ" && COLOR="danger"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"${COLOR}"'",
                "blocks": [
                  {"type": "header", "text": {"type": "plain_text", "text": "'"${EMOJI}"' QA Promotion Complete", "emoji": true}},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${{ needs.detect-version.outputs.image_tag }}"'`"},
                    {"type": "mrkdwn", "text": "*Status:*\n'"${STATUS}"'"}
                  ]},
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*Canary Deployment Started:*\nğŸ¤ 10% â†’ 30% â†’ 60% â†’ 100%"}},
                  {"type": "actions", "elements": [
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“Š Monitor Canary"}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/workflows/50-cd-canary-monitor.yaml"},
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ” View QA"}, "url": "https://opsera-voting-app-qa.agent.opsera.dev"}
                  ]}
                ]
              }]
            }' \
            "$SLACK_WEBHOOK" || true
