# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                â•‘
# â•‘              ENTERPRISE CD PIPELINE - PROMOTE TO QA                            â•‘
# â•‘                                                                                â•‘
# â•‘  Stage 4 of the CI/CD Pipeline:                                                â•‘
# â•‘  â€¢ Jira ticket creation & tracking                                             â•‘
# â•‘  â€¢ Detect current DEV version                                                  â•‘
# â•‘  â€¢ Pre-flight checks (DEV health validation)                                   â•‘
# â•‘  â€¢ Manual approval gate via Slack + GitHub Environment                         â•‘
# â•‘  â€¢ Promote to QA with canary deployment                                        â•‘
# â•‘  â€¢ Generate architecture diagram                                               â•‘
# â•‘                                                                                â•‘
# â•‘  Powered by Opsera - The Unified DevOps Platform                               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "â¬†ï¸ CD: Promote to QA"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote (leave empty to auto-detect from DEV)'
        required: false
        type: string
      skip_approval:
        description: 'Skip approval gate (emergency only)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  QA_URL: https://opsera-voting-app-qa.agent.opsera.dev
  QA_RESULTS_URL: https://results.opsera-voting-app-qa.agent.opsera.dev
  # Jira Configuration
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL || 'https://opsera-jira-mock-labs.agent.opsera.dev' }}
  JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY || 'PR1' }}

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DETECT VERSION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-version:
    name: "ğŸ” Detect Version"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect.outputs.image_tag }}
      commit_hash: ${{ steps.detect.outputs.commit_hash }}
      commit_url: ${{ steps.detect.outputs.commit_url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Detect DEV Version
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            # Extract from DEV kustomization
            IMAGE_TAG=$(grep -A2 "name: vote$" .opsera-${{ env.APP_NAME }}/k8s/overlays/dev/kustomization.yaml | grep "newTag" | awk -F': ' '{print $2}' | tr -d ' "')
          fi
          
          COMMIT_HASH=$(echo "$IMAGE_TAG" | cut -d'-' -f1)
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_HASH}"
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_url=${COMMIT_URL}" >> $GITHUB_OUTPUT
          
          echo "### ğŸ” Version Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [${COMMIT_HASH}](${COMMIT_URL}) |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JIRA: CREATE PROMOTION TICKET
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  jira-create-ticket:
    name: "ğŸ« Create Jira Ticket"
    runs-on: ubuntu-latest
    needs: [detect-version]
    outputs:
      ticket_key: ${{ steps.create.outputs.ticket_key }}
      ticket_url: ${{ steps.create.outputs.ticket_url }}
    
    steps:
      - name: Create Promotion Ticket
        id: create
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          IMAGE_TAG: ${{ needs.detect-version.outputs.image_tag }}
        run: |
          echo "## ğŸ« Jira Promotion Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$JIRA_TOKEN" ]; then
            echo "âš ï¸ Jira not configured - using mock ticket" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=MOCK-002" >> $GITHUB_OUTPUT
            echo "ticket_url=${{ env.JIRA_BASE_URL }}/ui" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          DESCRIPTION="â¬†ï¸ QA Promotion Request

ğŸ“‹ Promotion Details:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Image Tag: ${IMAGE_TAG}
â€¢ From: DEV â†’ QA
â€¢ Deployment Type: Canary (10% â†’ 30% â†’ 60% â†’ 100%)
â€¢ Requested: ${TIMESTAMP}
â€¢ Requested By: ${GITHUB_ACTOR}
â€¢ Workflow: ${WORKFLOW_URL}

ğŸ”„ Promotion Stages:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ ] Pre-flight check (DEV health)
[ ] Approval gate
[ ] Update QA manifests
[ ] ArgoCD sync
[ ] Canary rollout (10% â†’ 100%)
[ ] Generate architecture diagram"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue" \
            -d "{
              \"fields\": {
                \"project\": {\"key\": \"${{ env.JIRA_PROJECT_KEY }}\"},
                \"summary\": \"[Promote] QA: ${IMAGE_TAG} - ${{ env.APP_NAME }}\",
                \"description\": \"${DESCRIPTION}\",
                \"issuetype\": {\"name\": \"Task\"},
                \"priority\": {\"name\": \"High\"}
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TICKET_KEY=$(echo "$BODY" | jq -r '.key')
            TICKET_URL="${{ env.JIRA_BASE_URL }}/ui?issue=${TICKET_KEY}"
            
            echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
            echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Failed to create Jira ticket (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=" >> $GITHUB_OUTPUT
            echo "ticket_url=" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRE-FLIGHT CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  preflight-check:
    name: "ğŸ” Pre-flight Check"
    runs-on: ubuntu-latest
    needs: [detect-version, jira-create-ticket]
    outputs:
      dev_healthy: ${{ steps.check.outputs.dev_healthy }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Check DEV Health
        id: check
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          HEALTH=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
          SYNC=$(kubectl get application "${{ env.APP_NAME }}-dev" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
          
          echo "### ğŸ” Pre-flight Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Health | Sync |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          [ "$HEALTH" = "Healthy" ] && H_EMOJI="ğŸŸ¢" || H_EMOJI="ğŸ”´"
          [ "$SYNC" = "Synced" ] && S_EMOJI="âœ…" || S_EMOJI="âš ï¸"
          
          echo "| DEV | ${H_EMOJI} ${HEALTH} | ${S_EMOJI} ${SYNC} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH" = "Healthy" ]; then
            echo "dev_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "dev_healthy=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning:** DEV is not healthy. Promotion may fail." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update Jira - Pre-flight Complete
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          HEALTHY="${{ steps.check.outputs.dev_healthy }}"
          [ "$HEALTHY" = "true" ] && MSG="âœ… Pre-flight check passed - DEV is healthy" || MSG="âš ï¸ Pre-flight check warning - DEV health issues detected"
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${MSG}\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SLACK APPROVAL REQUEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  request-approval:
    name: "ğŸ“¨ Request Approval"
    runs-on: ubuntu-latest
    needs: [detect-version, jira-create-ticket, preflight-check]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    
    steps:
      - name: Send Slack Approval Request
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not configured"
            exit 0
          fi
          
          IMAGE_TAG="${{ needs.detect-version.outputs.image_tag }}"
          COMMIT_URL="${{ needs.detect-version.outputs.commit_url }}"
          COMMIT_HASH="${{ needs.detect-version.outputs.commit_hash }}"
          APPROVE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          JIRA_TEXT=""
          [ -n "$TICKET_KEY" ] && JIRA_TEXT="*Jira:* <${TICKET_URL}|${TICKET_KEY}>\n"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {"type": "header", "text": {"type": "plain_text", "text": "ğŸš¦ QA Promotion Approval Required", "emoji": true}},
                {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${IMAGE_TAG}"'`"},
                  {"type": "mrkdwn", "text": "*Commit:*\n<'"${COMMIT_URL}"'|'"${COMMIT_HASH}"'>"}
                ]},
                {"type": "section", "text": {"type": "mrkdwn", "text": "'"${JIRA_TEXT}"'*Promotion Flow:*\nDEV âœ… â†’ *QA* ğŸ¤ (Canary: 10% â†’ 30% â†’ 60% â†’ 100%)"}},
                {"type": "divider"},
                {"type": "actions", "elements": [
                  {"type": "button", "text": {"type": "plain_text", "text": "âœ… Approve & Deploy"}, "style": "primary", "url": "'"${APPROVE_URL}"'"},
                  {"type": "button", "text": {"type": "plain_text", "text": "ğŸ‘€ View Changes"}, "url": "'"${COMMIT_URL}"'"}
                ]},
                {"type": "context", "elements": [
                  {"type": "mrkdwn", "text": "Requested by *${{ github.actor }}* | <'"${APPROVE_URL}"'|View Workflow>"}
                ]}
              ]
            }' \
            "$SLACK_WEBHOOK"
          
          echo "### ğŸ“¨ Approval Request Sent" >> $GITHUB_STEP_SUMMARY
          echo "Slack notification sent. Waiting for approval..." >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - Awaiting Approval
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"â³ Awaiting approval for QA promotion\\n\\nSlack notification sent. Manual approval required via GitHub Environment.\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # APPROVAL GATE (GitHub Environment)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  approval-gate:
    name: "ğŸš¦ Approval Gate"
    runs-on: ubuntu-latest
    needs: [detect-version, jira-create-ticket, preflight-check, request-approval]
    if: ${{ github.event.inputs.skip_approval != 'true' }}
    environment:
      name: qa-approval
      url: https://opsera-voting-app-qa.agent.opsera.dev
    
    steps:
      - name: Approval Confirmed
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          echo "### ğŸš¦ Approval Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment to QA approved!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Approved By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.detect-version.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Update Jira
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"âœ… Approval granted\\n\\nApproved by: ${{ github.actor }}\\nTime: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO QA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-qa:
    name: "ğŸš€ Deploy to QA"
    runs-on: ubuntu-latest
    needs: [detect-version, jira-create-ticket, approval-gate]
    if: always() && (needs.approval-gate.result == 'success' || github.event.inputs.skip_approval == 'true')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update QA Manifests
        env:
          IMAGE_TAG: ${{ needs.detect-version.outputs.image_tag }}
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/qa/kustomization.yaml"
          
          # Update image references
          sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"
          
          echo "### ğŸ“ QA Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "Updated with tag: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        env:
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git diff --staged --quiet || git commit -m "chore(qa): promote ${{ needs.detect-version.outputs.image_tag }} from DEV [skip ci]

Jira: ${TICKET_KEY}"
          git push origin main || echo "No changes to push"

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          kubectl patch application "${{ env.APP_NAME }}-qa" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true

      - name: Update Jira - Deploy Started
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"ğŸš€ QA deployment started\\n\\nâ€¢ Manifests updated\\nâ€¢ ArgoCD sync triggered\\nâ€¢ Canary rollout: 10% â†’ 30% â†’ 60% â†’ 100%\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ARCHITECTURE DIAGRAM
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-architecture:
    name: "ğŸ—ï¸ Architecture Diagram"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, deploy-qa]
    if: always() && needs.deploy-qa.result != 'cancelled'
    
    steps:
      - name: Generate Multi-Environment Architecture
        env:
          IMAGE_TAG: ${{ needs.detect-version.outputs.image_tag }}
        run: |
          echo "## ğŸ—ï¸ QA Deployment Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Multi-Environment Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'ARCH'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#2c5aa0', 'lineColor': '#5c5c5c', 'background': '#ffffff'}}}%%
flowchart TB
    subgraph INTERNET["â˜ï¸ INTERNET"]
        USER["ğŸ‘¤ Users"]
    end

    subgraph AWS["â˜ï¸ AWS CLOUD - us-west-2"]
        subgraph ROUTE53["ğŸŒ Route 53"]
            DNS_DEV["vote-dev.opsera.dev"]
            DNS_QA["vote-qa.opsera.dev"]
        end
        
        subgraph EKS["âˆ EKS: opsera-usw2-np"]
            subgraph NGINX_NS["ğŸ”· ingress-nginx"]
                NGINX["NGINX Ingress\n+ TLS Termination"]
            end
            
            subgraph DEV["ğŸ“¦ voting-app-dev"]
                direction LR
                DEV_VOTE["ğŸ—³ï¸ Vote\n(Stable)"]
                DEV_REDIS[("ğŸ”´ Redis")]
                DEV_WORKER["âš™ï¸ Worker"]
                DEV_DB[("ğŸ˜ Postgres")]
                DEV_RESULT["ğŸ“Š Result"]
            end
            
            subgraph QA["ğŸ“¦ voting-app-qa"]
                direction LR
                subgraph CANARY["ğŸ¤ Canary Deployment"]
                    QA_STABLE["ğŸ—³ï¸ Vote\n(Stable 90%)"]
                    QA_CANARY["ğŸ—³ï¸ Vote\n(Canary 10%)"]
                end
                QA_REDIS[("ğŸ”´ Redis")]
                QA_WORKER["âš™ï¸ Worker"]
                QA_DB[("ğŸ˜ Postgres")]
                QA_RESULT["ğŸ“Š Result"]
            end
            
            subgraph PLATFORM["ğŸ”§ Platform"]
                ARGOCD["ğŸ”„ ArgoCD"]
                ROLLOUTS["ğŸ“ˆ Argo Rollouts"]
            end
        end
        
        subgraph ECR["ğŸ“¦ ECR"]
            IMAGES["vote | result | worker\n:$TAG"]
        end
    end

    subgraph CICD["ğŸ”„ CI/CD"]
        GHA["âš¡ GitHub Actions"]
        REPO["ğŸ“‚ Git Repository"]
    end

    subgraph OBS["ğŸ“Š Observability"]
        NR["ğŸ“ˆ New Relic"]
        SLACK["ğŸ’¬ Slack"]
        JIRA["ğŸ« Jira"]
    end

    %% Flow
    USER -->|"1ï¸âƒ£"| DNS_DEV & DNS_QA
    DNS_DEV & DNS_QA -->|"2ï¸âƒ£"| NGINX
    NGINX -->|"3ï¸âƒ£"| DEV & QA
    
    REPO -->|"4ï¸âƒ£ Push"| GHA
    GHA -->|"5ï¸âƒ£ Build"| ECR
    GHA -->|"6ï¸âƒ£ Sync"| ARGOCD
    ARGOCD -->|"7ï¸âƒ£ Deploy"| DEV & QA
    ROLLOUTS -->|"8ï¸âƒ£ Canary"| QA
    
    DEV_VOTE --> DEV_REDIS --> DEV_WORKER --> DEV_DB --> DEV_RESULT
    QA_STABLE & QA_CANARY --> QA_REDIS --> QA_WORKER --> QA_DB --> QA_RESULT
    
    QA -.->|"Metrics"| NR
    GHA -.->|"Notify"| SLACK & JIRA
    NR -.->|"Analysis"| ROLLOUTS

    style CANARY fill:#fff3cd,stroke:#ffc107
    style QA_CANARY fill:#28a745,stroke:#1e7e34,color:#fff
```
ARCH

      - name: Generate Canary Sequence Diagram
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Canary Deployment Sequence" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'SEQ'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'actorBkg': '#4a90d9', 'actorTextColor': '#fff'}}}%%
sequenceDiagram
    autonumber
    
    participant DEV as ğŸ‘¨â€ğŸ’» Developer
    participant GHA as âš¡ GitHub Actions
    participant JIRA as ğŸ« Jira
    participant ARGO as ğŸ”„ ArgoCD
    participant ROLLOUT as ğŸ“ˆ Argo Rollouts
    participant K8S as âˆ Kubernetes
    participant NR as ğŸ“ˆ New Relic
    participant SLACK as ğŸ’¬ Slack

    rect rgb(255, 248, 240)
        Note over DEV,GHA: Promotion Request
        DEV->>GHA: Request QA promotion
        GHA->>JIRA: Create promotion ticket
        GHA->>SLACK: Request approval
    end

    rect rgb(240, 255, 240)
        Note over GHA,ARGO: Approval & Deploy
        DEV->>GHA: âœ… Approve promotion
        GHA->>GHA: Update QA manifests
        GHA->>ARGO: Trigger sync
        ARGO->>K8S: Apply rollout spec
    end

    rect rgb(255, 255, 220)
        Note over ROLLOUT,NR: Canary Phase 1 (10%)
        ROLLOUT->>K8S: Scale canary to 10%
        K8S->>K8S: Route 10% traffic to canary
        loop Every 30s for 2 min
            NR->>NR: Collect metrics
            ROLLOUT->>NR: Query error rate, latency
        end
        NR-->>ROLLOUT: âœ… Metrics healthy
        ROLLOUT->>JIRA: ğŸ“ 10% canary healthy
    end

    rect rgb(255, 250, 230)
        Note over ROLLOUT,NR: Canary Phase 2 (30%)
        ROLLOUT->>K8S: Scale canary to 30%
        loop Analysis
            ROLLOUT->>NR: Query metrics
        end
        NR-->>ROLLOUT: âœ… Healthy
    end

    rect rgb(255, 245, 220)
        Note over ROLLOUT,NR: Canary Phase 3 (60%)
        ROLLOUT->>K8S: Scale canary to 60%
        loop Analysis
            ROLLOUT->>NR: Query metrics
        end
        NR-->>ROLLOUT: âœ… Healthy
    end

    rect rgb(240, 255, 240)
        Note over ROLLOUT,SLACK: Full Promotion (100%)
        ROLLOUT->>K8S: Promote to 100%
        ROLLOUT->>K8S: Scale down stable
        ROLLOUT->>JIRA: âœ… Promotion complete
        ROLLOUT->>SLACK: âœ… QA deployment successful
    end

    rect rgb(255, 230, 230)
        Note over ROLLOUT,SLACK: Rollback (if unhealthy)
        alt Metrics unhealthy
            ROLLOUT->>K8S: âŒ Abort canary
            K8S->>K8S: Route 100% to stable
            ROLLOUT->>JIRA: âŒ Rollback triggered
            ROLLOUT->>SLACK: âš ï¸ Canary failed
        end
    end
```
SEQ

      - name: Generate Traffic Split Diagram
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Canary Traffic Progression" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'TRAFFIC'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff'}}}%%
gantt
    title Canary Traffic Progression
    dateFormat X
    axisFormat %s
    
    section Stable (Old)
    100% Traffic    :done, s1, 0, 1
    90% Traffic     :done, s2, 1, 2
    70% Traffic     :done, s3, 2, 3
    40% Traffic     :done, s4, 3, 4
    0% Traffic      :done, s5, 4, 5
    
    section Canary (New)
    0% Traffic      :c1, 0, 1
    10% Traffic     :active, c2, 1, 2
    30% Traffic     :c3, 2, 3
    60% Traffic     :c4, 3, 4
    100% Traffic    :crit, c5, 4, 5
```

| Phase | Stable | Canary | Duration | Analysis |
|-------|--------|--------|----------|----------|
| Start | 100% | 0% | - | Baseline |
| Step 1 | 90% | 10% | 2 min | Error rate < 1% |
| Step 2 | 70% | 30% | 2 min | Latency p99 < 500ms |
| Step 3 | 40% | 60% | 2 min | Apdex > 0.9 |
| Complete | 0% | 100% | - | Full promotion |
TRAFFIC

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY COMPLETION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-complete:
    name: "ğŸ“¢ Notify"
    runs-on: ubuntu-latest
    needs: [detect-version, jira-create-ticket, deploy-qa, generate-architecture]
    if: always()
    
    steps:
      - name: Update Jira - Promotion Complete
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          STATUS="${{ needs.deploy-qa.result }}"
          [ "$STATUS" = "success" ] && RESULT="âœ… SUCCESSFUL" || RESULT="âš ï¸ COMPLETED WITH WARNINGS"
          
          COMMENT="â¬†ï¸ QA PROMOTION ${RESULT}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ Final Status:
â€¢ Image Tag: ${{ needs.detect-version.outputs.image_tag }}
â€¢ Target: QA
â€¢ Deployment: Canary (10% â†’ 100%)

ğŸ”— Application URLs:
â€¢ Vote: ${{ env.QA_URL }}
â€¢ Results: ${{ env.QA_RESULTS_URL }}

ğŸ“Š Canary Status:
â€¢ Initial weight: 10%
â€¢ Final weight: 100% (if healthy)
â€¢ Analysis: New Relic metrics

ğŸ—ï¸ Architecture diagram generated in GitHub Actions summary."
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${COMMENT}\"}" || true

      - name: Generate Summary
        env:
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          echo "## â¬†ï¸ QA Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$TICKET_KEY" ]; then
            echo "### ğŸ« Jira Tracking" >> $GITHUB_STEP_SUMMARY
            echo "**Ticket:** [${TICKET_KEY}](${TICKET_URL})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.detect-version.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | QA |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment Type** | Canary |" >> $GITHUB_STEP_SUMMARY
          echo "| **Promoted At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote App | [${{ env.QA_URL }}](${{ env.QA_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Results App | [${{ env.QA_RESULTS_URL }}](${{ env.QA_RESULTS_URL }}) |" >> $GITHUB_STEP_SUMMARY

      - name: Send Completion Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then exit 0; fi
          
          STATUS="${{ needs.deploy-qa.result }}"
          [ "$STATUS" = "success" ] && EMOJI="âœ…" && COLOR="good" || EMOJI="âŒ" && COLOR="danger"
          
          JIRA_BLOCK=""
          [ -n "$TICKET_KEY" ] && JIRA_BLOCK=',{"type": "section", "text": {"type": "mrkdwn", "text": "ğŸ« *Jira:* <'"${TICKET_URL}"'|'"${TICKET_KEY}"'>"}}'
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"${COLOR}"'",
                "blocks": [
                  {"type": "header", "text": {"type": "plain_text", "text": "'"${EMOJI}"' QA Promotion Complete", "emoji": true}},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${{ needs.detect-version.outputs.image_tag }}"'`"},
                    {"type": "mrkdwn", "text": "*Status:*\n'"${STATUS}"'"}
                  ]}'"${JIRA_BLOCK}"',
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*Canary Deployment Started:*\nğŸ¤ 10% â†’ 30% â†’ 60% â†’ 100%"}},
                  {"type": "context", "elements": [{"type": "mrkdwn", "text": "ğŸ“Š Architecture diagram available in <'"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"'|workflow summary>"}]},
                  {"type": "actions", "elements": [
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“Š Monitor Canary"}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/workflows/50-cd-canary-monitor.yaml"},
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ” View QA"}, "url": "'"${{ env.QA_URL }}"'"}
                  ]}
                ]
              }]
            }' \
            "$SLACK_WEBHOOK" || true
