# Temporary workflow - Test canary analysis with different providers
name: "tmp: Test Canary Analysis"

on:
  workflow_dispatch:
    inputs:
      analysis_provider:
        description: 'Analysis provider (newrelic, prometheus, http)'
        required: true
        type: string
        default: 'newrelic'
      trigger_rollout:
        description: 'Trigger rollout after switching'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  switch-analysis:
    name: "Switch to ${{ inputs.analysis_provider }}"
    runs-on: ubuntu-latest
    outputs:
      template_name: ${{ steps.switch.outputs.template_name }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Determine Template Name
        id: switch
        run: |
          PROVIDER="${{ inputs.analysis_provider }}"
          
          case "$PROVIDER" in
            newrelic)
              TEMPLATE="newrelic-combined-analysis"
              ;;
            prometheus)
              TEMPLATE="success-rate"
              ;;
            http|*)
              TEMPLATE="http-health-check"
              ;;
          esac
          
          echo "template_name=$TEMPLATE" >> $GITHUB_OUTPUT
          echo "## Analysis Template Selection" >> $GITHUB_STEP_SUMMARY
          echo "Provider: **$PROVIDER**" >> $GITHUB_STEP_SUMMARY
          echo "Template: **$TEMPLATE**" >> $GITHUB_STEP_SUMMARY

      - name: Update QA Rollout Patch
        env:
          TEMPLATE: ${{ steps.switch.outputs.template_name }}
          PROVIDER: ${{ inputs.analysis_provider }}
        run: |
          PATCH_FILE=".opsera-voting-app/k8s/overlays/qa/patch-rollout-replicas.yaml"
          
          if [ "$PROVIDER" = "newrelic" ]; then
            ARGS_BLOCK='args:
                  - name: app-name
                    value: vote
                  - name: error-threshold
                    value: "5"
                  - name: latency-threshold
                    value: "500"
                  - name: apdex-threshold
                    value: "0.85"'
            RESULT_ARGS='args:
                  - name: app-name
                    value: result
                  - name: error-threshold
                    value: "5"
                  - name: latency-threshold
                    value: "500"
                  - name: apdex-threshold
                    value: "0.85"'
          elif [ "$PROVIDER" = "prometheus" ]; then
            ARGS_BLOCK='args:
                  - name: service-name
                    value: vote
                  - name: ingress-name
                    value: voting-app'
            RESULT_ARGS='args:
                  - name: service-name
                    value: result
                  - name: ingress-name
                    value: voting-app-result'
          else
            ARGS_BLOCK='args:
                  - name: service-name
                    value: vote
                  - name: namespace
                    value: voting-app-qa'
            RESULT_ARGS='args:
                  - name: service-name
                    value: result
                  - name: namespace
                    value: voting-app-qa'
          fi
          
          cat > "$PATCH_FILE" << EOF
          # QA environment - Testing $PROVIDER canary analysis
          apiVersion: argoproj.io/v1alpha1
          kind: Rollout
          metadata:
            name: vote-rollout
          spec:
            replicas: 4
            strategy:
              canary:
                steps:
                - setWeight: 10
                - pause: {duration: 1m}
                - setWeight: 30
                - pause: {duration: 1m}
                - setWeight: 60
                - pause: {duration: 1m}
                - setWeight: 100
                analysis:
                  templates:
                  - templateName: $TEMPLATE
                  startingStep: 1
                  $ARGS_BLOCK
                trafficRouting:
                  nginx:
                    stableIngress: voting-app
                    annotationPrefix: nginx.ingress.kubernetes.io
          ---
          apiVersion: argoproj.io/v1alpha1
          kind: Rollout
          metadata:
            name: result-rollout
          spec:
            replicas: 3
            strategy:
              canary:
                steps:
                - setWeight: 10
                - pause: {duration: 1m}
                - setWeight: 30
                - pause: {duration: 1m}
                - setWeight: 60
                - pause: {duration: 1m}
                - setWeight: 100
                analysis:
                  templates:
                  - templateName: $TEMPLATE
                  startingStep: 1
                  $RESULT_ARGS
                trafficRouting:
                  nginx:
                    stableIngress: voting-app-result
                    annotationPrefix: nginx.ingress.kubernetes.io
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: worker
          spec:
            replicas: 2
          EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Patch File Updated" >> $GITHUB_STEP_SUMMARY
          echo "Updated: \`$PATCH_FILE\`" >> $GITHUB_STEP_SUMMARY

      - name: Update Kustomization Patches
        env:
          PROVIDER: ${{ inputs.analysis_provider }}
        run: |
          KUST_FILE=".opsera-voting-app/k8s/overlays/qa/kustomization.yaml"
          
          # Remove existing analysis template deletion patches
          sed -i '/# Exclude NewRelic/,/name: success-rate/{ /# Exclude NewRelic/,/name: success-rate/d; }' "$KUST_FILE" || true
          sed -i '/# Keep NewRelic/,/name: success-rate/{ /# Keep NewRelic/,/name: success-rate/d; }' "$KUST_FILE" || true
          sed -i '/# Keep Prometheus/,/name: newrelic-combined-analysis/{ /# Keep Prometheus/,/name: newrelic-combined-analysis/d; }' "$KUST_FILE" || true
          
          # Add appropriate patches based on provider
          if [ "$PROVIDER" = "newrelic" ]; then
            cat >> "$KUST_FILE" << 'EOF'
  # Testing New Relic - delete Prometheus template
  - target:
      kind: AnalysisTemplate
      name: success-rate
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: success-rate
EOF
          elif [ "$PROVIDER" = "prometheus" ]; then
            cat >> "$KUST_FILE" << 'EOF'
  # Testing Prometheus - delete New Relic templates
  - target:
      kind: AnalysisTemplate
      name: newrelic-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-nrql-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-nrql-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-combined-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-combined-analysis
EOF
          else
            cat >> "$KUST_FILE" << 'EOF'
  # Testing HTTP - delete both New Relic and Prometheus templates
  - target:
      kind: AnalysisTemplate
      name: success-rate
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: success-rate
  - target:
      kind: AnalysisTemplate
      name: newrelic-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-nrql-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-nrql-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-combined-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-combined-analysis
EOF
          fi
          
          echo "Kustomization updated for $PROVIDER" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "test(${{ inputs.analysis_provider }}): switch canary to ${{ steps.switch.outputs.template_name }}"
          git push origin main

  trigger-rollout:
    name: "Trigger Rollout"
    runs-on: ubuntu-latest
    needs: [switch-analysis]
    if: inputs.trigger_rollout == true
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true
          
          echo "## ArgoCD Sync" >> $GITHUB_STEP_SUMMARY
          echo "Triggered sync for voting-app-qa" >> $GITHUB_STEP_SUMMARY
          
          sleep 30

      - name: Restart Rollouts
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl-argo-rollouts restart vote-rollout -n voting-app-qa || true
          kubectl-argo-rollouts restart result-rollout -n voting-app-qa || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Rollouts Restarted" >> $GITHUB_STEP_SUMMARY

  monitor-canary:
    name: "Monitor Canary"
    runs-on: ubuntu-latest
    needs: [switch-analysis, trigger-rollout]
    if: inputs.trigger_rollout == true
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Monitor Progress
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "## Canary Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "Provider: **${{ inputs.analysis_provider }}**" >> $GITHUB_STEP_SUMMARY
          echo "Template: **${{ needs.switch-analysis.outputs.template_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 10); do
            echo "### Check $i/10" >> $GITHUB_STEP_SUMMARY
            
            PHASE=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            STEP=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")
            
            echo "Phase: $PHASE, Step: $STEP" >> $GITHUB_STEP_SUMMARY
            
            echo "**Analysis Runs:**" >> $GITHUB_STEP_SUMMARY
            kubectl get analysisruns -n voting-app-qa --sort-by='.metadata.creationTimestamp' 2>/dev/null | tail -3 >> $GITHUB_STEP_SUMMARY || echo "None" >> $GITHUB_STEP_SUMMARY
            
            echo "---" >> $GITHUB_STEP_SUMMARY
            
            if [ "$PHASE" = "Healthy" ]; then
              echo "Rollout completed successfully!" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            sleep 30
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Final Status" >> $GITHUB_STEP_SUMMARY
          kubectl-argo-rollouts get rollout vote-rollout -n voting-app-qa 2>&1 | head -30 >> $GITHUB_STEP_SUMMARY || true
