name: "tmp: Test Canary"

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Analysis provider (newrelic, prometheus, http)'
        required: true
        default: 'newrelic'

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  switch-and-deploy:
    name: "Switch to ${{ inputs.provider }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Determine Template
        id: template
        run: |
          case "${{ inputs.provider }}" in
            newrelic)
              echo "name=newrelic-combined-analysis" >> $GITHUB_OUTPUT
              ;;
            prometheus)
              echo "name=success-rate" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=http-health-check" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Update Rollout Patch
        run: |
          TEMPLATE="${{ steps.template.outputs.name }}"
          PROVIDER="${{ inputs.provider }}"
          PATCH_FILE=".opsera-voting-app/k8s/overlays/qa/patch-rollout-replicas.yaml"
          
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Provider: **$PROVIDER**" >> $GITHUB_STEP_SUMMARY
          echo "- Template: **$TEMPLATE**" >> $GITHUB_STEP_SUMMARY
          
          # Set args based on provider
          if [ "$PROVIDER" = "newrelic" ]; then
            VOTE_ARGS="args:
                  - name: app-name
                    value: vote
                  - name: error-threshold
                    value: \"5\"
                  - name: latency-threshold
                    value: \"500\"
                  - name: apdex-threshold
                    value: \"0.85\""
            RESULT_ARGS="args:
                  - name: app-name
                    value: result
                  - name: error-threshold
                    value: \"5\"
                  - name: latency-threshold
                    value: \"500\"
                  - name: apdex-threshold
                    value: \"0.85\""
          elif [ "$PROVIDER" = "prometheus" ]; then
            VOTE_ARGS="args:
                  - name: service-name
                    value: vote
                  - name: ingress-name
                    value: voting-app"
            RESULT_ARGS="args:
                  - name: service-name
                    value: result
                  - name: ingress-name
                    value: voting-app-result"
          else
            VOTE_ARGS="args:
                  - name: service-name
                    value: vote
                  - name: namespace
                    value: voting-app-qa"
            RESULT_ARGS="args:
                  - name: service-name
                    value: result
                  - name: namespace
                    value: voting-app-qa"
          fi
          
          cat > "$PATCH_FILE" << EOFPATCH
          # QA - Testing $PROVIDER canary analysis
          apiVersion: argoproj.io/v1alpha1
          kind: Rollout
          metadata:
            name: vote-rollout
          spec:
            replicas: 4
            strategy:
              canary:
                steps:
                - setWeight: 10
                - pause: {duration: 1m}
                - setWeight: 30
                - pause: {duration: 1m}
                - setWeight: 60
                - pause: {duration: 1m}
                - setWeight: 100
                analysis:
                  templates:
                  - templateName: $TEMPLATE
                  startingStep: 1
                  $VOTE_ARGS
                trafficRouting:
                  nginx:
                    stableIngress: voting-app
                    annotationPrefix: nginx.ingress.kubernetes.io
          ---
          apiVersion: argoproj.io/v1alpha1
          kind: Rollout
          metadata:
            name: result-rollout
          spec:
            replicas: 3
            strategy:
              canary:
                steps:
                - setWeight: 10
                - pause: {duration: 1m}
                - setWeight: 30
                - pause: {duration: 1m}
                - setWeight: 60
                - pause: {duration: 1m}
                - setWeight: 100
                analysis:
                  templates:
                  - templateName: $TEMPLATE
                  startingStep: 1
                  $RESULT_ARGS
                trafficRouting:
                  nginx:
                    stableIngress: voting-app-result
                    annotationPrefix: nginx.ingress.kubernetes.io
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: worker
          spec:
            replicas: 2
          EOFPATCH

      - name: Update Kustomization
        run: |
          PROVIDER="${{ inputs.provider }}"
          KUST_FILE=".opsera-voting-app/k8s/overlays/qa/kustomization.yaml"
          
          # Clean up old analysis template patches
          # Using perl for more reliable multiline matching
          perl -i -0pe 's/\s*#\s*(?:Exclude|Keep|Testing).*?AnalysisTemplate.*?name:\s*\w+\n//gs' "$KUST_FILE" || true
          
          # Add patches based on provider
          if [ "$PROVIDER" = "newrelic" ]; then
            cat >> "$KUST_FILE" << 'EOF'
  # Testing New Relic - keep NR templates, delete Prometheus
  - target:
      kind: AnalysisTemplate
      name: success-rate
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: success-rate
EOF
          elif [ "$PROVIDER" = "prometheus" ]; then
            cat >> "$KUST_FILE" << 'EOF'
  # Testing Prometheus - keep success-rate, delete NR templates  
  - target:
      kind: AnalysisTemplate
      name: newrelic-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-nrql-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-nrql-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-combined-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-combined-analysis
EOF
          fi

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "test(${{ inputs.provider }}): switch canary to ${{ steps.template.outputs.name }}"
          git push origin main
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Committed" >> $GITHUB_STEP_SUMMARY

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Sync ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          sleep 5
          kubectl patch application voting-app-qa -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"gha"},"sync":{"prune":true}}}' || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Synced" >> $GITHUB_STEP_SUMMARY
          sleep 30

      - name: Restart Rollouts
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          kubectl-argo-rollouts restart vote-rollout -n voting-app-qa 2>&1 || true
          kubectl-argo-rollouts restart result-rollout -n voting-app-qa 2>&1 || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollouts Restarted" >> $GITHUB_STEP_SUMMARY

  monitor:
    name: "Monitor Canary"
    runs-on: ubuntu-latest
    needs: [switch-and-deploy]
    
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Monitor Rollout
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "## Canary Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "Provider: **${{ inputs.provider }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 12); do
            echo "### Check $i/12 ($(date +%H:%M:%S))" >> $GITHUB_STEP_SUMMARY
            
            PHASE=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            STEP=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "-")
            WEIGHT=$(kubectl get rollout vote-rollout -n voting-app-qa -o jsonpath='{.status.canary.weight}' 2>/dev/null || echo "-")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | $PHASE |" >> $GITHUB_STEP_SUMMARY
            echo "| Step | $STEP |" >> $GITHUB_STEP_SUMMARY
            echo "| Weight | ${WEIGHT}% |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Analysis Runs:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get analysisruns -n voting-app-qa --sort-by='.metadata.creationTimestamp' 2>/dev/null | tail -5 >> $GITHUB_STEP_SUMMARY || echo "None found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            
            if [ "$PHASE" = "Healthy" ]; then
              echo "## SUCCESS - Rollout Completed!" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ "$PHASE" = "Degraded" ]; then
              echo "## FAILED - Rollout Degraded!" >> $GITHUB_STEP_SUMMARY
              kubectl-argo-rollouts get rollout vote-rollout -n voting-app-qa 2>&1 >> $GITHUB_STEP_SUMMARY || true
              exit 1
            fi
            
            sleep 30
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Final Rollout Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl-argo-rollouts get rollout vote-rollout -n voting-app-qa 2>&1 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
