# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                â•‘
# â•‘              ENTERPRISE CD PIPELINE - CANARY MONITORING                        â•‘
# â•‘                                                                                â•‘
# â•‘  Stage 5 of the CI/CD Pipeline:                                                â•‘
# â•‘  â€¢ Monitor canary weight progression (10% â†’ 30% â†’ 60% â†’ 100%)                  â•‘
# â•‘  â€¢ Track rollout status and analysis runs                                      â•‘
# â•‘  â€¢ Provide manual promote/rollback controls                                    â•‘
# â•‘  â€¢ Generate real-time deployment dashboard                                     â•‘
# â•‘                                                                                â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ“Š CD: Canary Monitor"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - monitor
          - promote
          - abort
        default: 'monitor'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  SPOKE_CLUSTER: opsera-usw2-np
  NAMESPACE: voting-app-qa

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CANARY STATUS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  canary-status:
    name: "ðŸ“Š Canary Status"
    runs-on: ubuntu-latest
    outputs:
      vote_phase: ${{ steps.status.outputs.vote_phase }}
      vote_weight: ${{ steps.status.outputs.vote_weight }}
      result_phase: ${{ steps.status.outputs.result_phase }}
      result_weight: ${{ steps.status.outputs.result_weight }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Get Canary Status
        id: status
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "## ðŸ“Š Canary Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Summary table
          echo "### Rollout Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Rollout | Phase | Step | Canary Weight | Stable Weight |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|------|---------------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout result-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} &>/dev/null; then
              JSON=$(kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} -o json 2>/dev/null)
              
              PHASE=$(echo "$JSON" | jq -r '.status.phase // "Unknown"')
              STEP_INDEX=$(echo "$JSON" | jq -r '.status.currentStepIndex // 0')
              TOTAL_STEPS=$(echo "$JSON" | jq -r '.spec.strategy.canary.steps | length')
              
              CANARY_WEIGHT=$(echo "$JSON" | jq -r 'if .status.canary.weights.canary then .status.canary.weights.canary else 0 end')
              [[ ! "$CANARY_WEIGHT" =~ ^[0-9]+$ ]] && CANARY_WEIGHT=0
              STABLE_WEIGHT=$((100 - CANARY_WEIGHT))
              
              # Phase emoji
              case "$PHASE" in
                "Healthy") EMOJI="ðŸŸ¢" ;;
                "Progressing") EMOJI="ðŸ”µ" ;;
                "Paused") EMOJI="â¸ï¸" ;;
                "Degraded") EMOJI="ðŸ”´" ;;
                *) EMOJI="âšª" ;;
              esac
              
              echo "| ${ROLLOUT} | ${EMOJI} ${PHASE} | ${STEP_INDEX}/${TOTAL_STEPS} | ${CANARY_WEIGHT}% | ${STABLE_WEIGHT}% |" >> $GITHUB_STEP_SUMMARY
              
              # Outputs
              if [ "$ROLLOUT" = "vote-rollout" ]; then
                echo "vote_phase=${PHASE}" >> $GITHUB_OUTPUT
                echo "vote_weight=${CANARY_WEIGHT}" >> $GITHUB_OUTPUT
              else
                echo "result_phase=${PHASE}" >> $GITHUB_OUTPUT
                echo "result_weight=${CANARY_WEIGHT}" >> $GITHUB_OUTPUT
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Canary Progress Visualization
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "### ðŸ¤ Canary Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout result-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} &>/dev/null; then
              JSON=$(kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} -o json 2>/dev/null)
              STEP_INDEX=$(echo "$JSON" | jq -r '.status.currentStepIndex // 0')
              TOTAL_STEPS=$(echo "$JSON" | jq -r '.spec.strategy.canary.steps | length')
              
              SERVICE=$(echo "$ROLLOUT" | sed 's/-rollout//')
              echo "**${SERVICE}:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              
              PROGRESS=""
              for i in $(seq 0 $((TOTAL_STEPS - 1))); do
                if [ "$i" -lt "$STEP_INDEX" ]; then
                  PROGRESS="${PROGRESS}[âœ…]"
                elif [ "$i" -eq "$STEP_INDEX" ]; then
                  PROGRESS="${PROGRESS}[â–¶ï¸]"
                else
                  PROGRESS="${PROGRESS}[â¬œ]"
                fi
              done
              
              echo "$PROGRESS" >> $GITHUB_STEP_SUMMARY
              echo "Step ${STEP_INDEX}/${TOTAL_STEPS}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Detailed Step View
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          echo "### Step-by-Step Progression" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} &>/dev/null; then
              JSON=$(kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} -o json 2>/dev/null)
              STEP_INDEX=$(echo "$JSON" | jq -r '.status.currentStepIndex // 0')
              TOTAL_STEPS=$(echo "$JSON" | jq -r '.spec.strategy.canary.steps | length')
              
              echo "| Step | Action | Status |" >> $GITHUB_STEP_SUMMARY
              echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
              
              for i in $(seq 0 $((TOTAL_STEPS - 1))); do
                STEP=$(echo "$JSON" | jq -r ".spec.strategy.canary.steps[$i]")
                WEIGHT=$(echo "$STEP" | jq -r '.setWeight // empty')
                PAUSE=$(echo "$STEP" | jq -r '.pause.duration // empty')
                
                if [ "$i" -lt "$STEP_INDEX" ]; then
                  MARKER="âœ… Complete"
                elif [ "$i" -eq "$STEP_INDEX" ]; then
                  MARKER="â–¶ï¸ **Current**"
                else
                  MARKER="â¬œ Pending"
                fi
                
                STEP_NUM=$((i + 1))
                if [ -n "$WEIGHT" ] && [ "$WEIGHT" != "null" ]; then
                  echo "| ${STEP_NUM} | Traffic ${WEIGHT}% | ${MARKER} |" >> $GITHUB_STEP_SUMMARY
                elif [ -n "$PAUSE" ] && [ "$PAUSE" != "null" ]; then
                  echo "| ${STEP_NUM} | Pause ${PAUSE} | ${MARKER} |" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MANUAL ACTIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  execute-action:
    name: "âš¡ Execute Action"
    runs-on: ubuntu-latest
    needs: [canary-status]
    if: ${{ github.event.inputs.action != 'monitor' }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Execute Action
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          ACTION="${{ github.event.inputs.action }}"
          
          echo "## âš¡ Action: ${ACTION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout result-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n ${{ env.NAMESPACE }} &>/dev/null; then
              echo "### ${ROLLOUT}" >> $GITHUB_STEP_SUMMARY
              
              case "$ACTION" in
                promote)
                  kubectl-argo-rollouts promote "$ROLLOUT" -n ${{ env.NAMESPACE }}
                  echo "âœ… Promoted to next step" >> $GITHUB_STEP_SUMMARY
                  ;;
                abort)
                  kubectl-argo-rollouts abort "$ROLLOUT" -n ${{ env.NAMESPACE }}
                  echo "âš ï¸ Rollout aborted - rolling back" >> $GITHUB_STEP_SUMMARY
                  ;;
              esac
              
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Notify Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then exit 0; fi
          
          ACTION="${{ github.event.inputs.action }}"
          [ "$ACTION" = "promote" ] && EMOJI="â­ï¸" && TEXT="Canary promoted to next step"
          [ "$ACTION" = "abort" ] && EMOJI="ðŸ›‘" && TEXT="Canary rollout aborted"
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {"type": "section", "text": {"type": "mrkdwn", "text": "'"${EMOJI}"' *'"${TEXT}"'*\n\nEnvironment: QA\nTriggered by: ${{ github.actor }}"}}
              ]
            }' \
            "$SLACK_WEBHOOK" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY & NEXT STEPS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“‹ Summary"
    runs-on: ubuntu-latest
    needs: [canary-status]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ›ï¸ Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| [â­ï¸ Promote](../workflows/50-cd-canary-monitor.yaml?action=promote) | Skip to next canary step |" >> $GITHUB_STEP_SUMMARY
          echo "| [ðŸ›‘ Abort](../workflows/50-cd-canary-monitor.yaml?action=abort) | Abort and rollback |" >> $GITHUB_STEP_SUMMARY
          echo "| [ðŸ“Š Refresh](../workflows/50-cd-canary-monitor.yaml?action=monitor) | Refresh status |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Environment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Vote App:** https://opsera-voting-app-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Results:** https://results.opsera-voting-app-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
