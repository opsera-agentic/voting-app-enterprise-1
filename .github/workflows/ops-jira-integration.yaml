# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  JIRA INTEGRATION - Deployment Tracking                                       â•‘
# â•‘                                                                                â•‘
# â•‘  Integrates with Jira for deployment tracking:                                 â•‘
# â•‘  â€¢ Create deployment tickets                                                   â•‘
# â•‘  â€¢ Update ticket status on deployment events                                   â•‘
# â•‘  â€¢ Link commits to Jira issues                                                 â•‘
# â•‘  â€¢ Generate release notes                                                      â•‘
# â•‘                                                                                â•‘
# â•‘  Configure: Set JIRA_BASE_URL, JIRA_API_TOKEN, JIRA_PROJECT_KEY secrets        â•‘
# â•‘  Supports: Opsera Mock Jira (API Key auth) and Atlassian Cloud (Basic auth)    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸŽ« Ops: Jira Integration"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Jira action'
        required: true
        type: choice
        options:
          - test-connection
          - create-deployment-ticket
          - update-ticket
          - link-commit
          - generate-release-notes
        default: 'test-connection'
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - qa
        default: 'dev'
      ticket_key:
        description: 'Jira ticket key (for update/link actions)'
        required: false
        type: string
      version:
        description: 'Version tag (for release notes)'
        required: false
        type: string
  
  # Called by deployment workflows
  workflow_call:
    inputs:
      action:
        required: true
        type: string
      environment:
        required: true
        type: string
      ticket_key:
        required: false
        type: string
      version:
        required: false
        type: string
      status:
        required: false
        type: string
        default: 'In Progress'
    outputs:
      ticket_key:
        description: "Created or updated ticket key"
        value: ${{ jobs.jira-action.outputs.ticket_key }}
      ticket_url:
        description: "Jira ticket URL"
        value: ${{ jobs.jira-action.outputs.ticket_url }}

env:
  # Configure these secrets in GitHub:
  # JIRA_BASE_URL: https://opsera-jira-mock-labs.agent.opsera.dev (Mock) or https://your-domain.atlassian.net (Cloud)
  # JIRA_API_TOKEN: API key (for Mock Jira) or API token (for Atlassian Cloud)
  # JIRA_PROJECT_KEY: PR1 (or your project key)
  # JIRA_USER_EMAIL: (optional, only needed for Atlassian Cloud basic auth)
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL || 'https://opsera-jira-mock-labs.agent.opsera.dev' }}
  APP_NAME: voting-app

jobs:
  jira-action:
    name: "ðŸŽ« Jira: ${{ inputs.action || github.event.inputs.action }}"
    runs-on: ubuntu-latest
    outputs:
      ticket_key: ${{ steps.action.outputs.ticket_key }}
      ticket_url: ${{ steps.action.outputs.ticket_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # TEST CONNECTION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ”— Test Jira Connection"
        if: inputs.action == 'test-connection' || github.event.inputs.action == 'test-connection'
        id: test
        run: |
          echo "## ðŸŽ« Jira Connection Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JIRA_URL="${{ env.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"
          JIRA_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          PROJECT_KEY="${{ secrets.JIRA_PROJECT_KEY }}"
          
          # Check if API token is configured
          if [ -z "$JIRA_TOKEN" ]; then
            echo "### âš ï¸ Jira Not Configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable Jira integration, configure these secrets:" >> $GITHUB_STEP_SUMMARY
            echo "- \`JIRA_BASE_URL\`: Your Jira instance URL" >> $GITHUB_STEP_SUMMARY
            echo "  - Mock Jira: \`https://opsera-jira-mock-labs.agent.opsera.dev\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Atlassian Cloud: \`https://your-domain.atlassian.net\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`JIRA_API_TOKEN\`: API key (Mock) or API token (Cloud)" >> $GITHUB_STEP_SUMMARY
            echo "- \`JIRA_PROJECT_KEY\`: Your Jira project key (e.g., PR1, VOTE)" >> $GITHUB_STEP_SUMMARY
            echo "- \`JIRA_USER_EMAIL\`: (Optional, only for Atlassian Cloud)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Once configured, Jira integration will:" >> $GITHUB_STEP_SUMMARY
            echo "- Create deployment tickets automatically" >> $GITHUB_STEP_SUMMARY
            echo "- Update ticket status on deployment events" >> $GITHUB_STEP_SUMMARY
            echo "- Link Git commits to Jira issues" >> $GITHUB_STEP_SUMMARY
            echo "- Generate release notes" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Determine auth method: Mock Jira uses X-API-Key, Atlassian uses basic auth
          if [[ "$JIRA_URL" == *"opsera"* ]] || [[ "$JIRA_URL" == *"mock"* ]] || [ -z "$JIRA_EMAIL" ]; then
            AUTH_HEADER="-H \"X-API-Key: ${JIRA_TOKEN}\""
            AUTH_TYPE="API Key"
            API_VERSION="2"
          else
            AUTH_HEADER="-u \"${JIRA_EMAIL}:${JIRA_TOKEN}\""
            AUTH_TYPE="Basic Auth"
            API_VERSION="3"
          fi
          
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Jira URL | \`${JIRA_URL}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Type | ${AUTH_TYPE} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Version | v${API_VERSION} |" >> $GITHUB_STEP_SUMMARY
          
          # Test project access (this works for both Mock and Cloud)
          if [ -n "$PROJECT_KEY" ]; then
            if [ "$AUTH_TYPE" = "API Key" ]; then
              PROJECT_RESPONSE=$(curl -s -w "\n%{http_code}" \
                -H "X-API-Key: ${JIRA_TOKEN}" \
                -H "Accept: application/json" \
                "${JIRA_URL}/rest/api/2/project/${PROJECT_KEY}")
            else
              PROJECT_RESPONSE=$(curl -s -w "\n%{http_code}" \
                -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
                -H "Accept: application/json" \
                "${JIRA_URL}/rest/api/3/project/${PROJECT_KEY}")
            fi
            
            PROJECT_CODE=$(echo "$PROJECT_RESPONSE" | tail -n1)
            if [ "$PROJECT_CODE" = "200" ]; then
              PROJECT_NAME=$(echo "$PROJECT_RESPONSE" | head -n -1 | jq -r '.name // "Unknown"')
              echo "| Project | ${PROJECT_NAME} (${PROJECT_KEY}) |" >> $GITHUB_STEP_SUMMARY
              echo "| Status | âœ… Connected |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Project | âš ï¸ Cannot access ${PROJECT_KEY} |" >> $GITHUB_STEP_SUMMARY
              echo "| Status | âŒ Failed (HTTP ${PROJECT_CODE}) |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            # Test by listing projects
            if [ "$AUTH_TYPE" = "API Key" ]; then
              RESPONSE=$(curl -s -w "\n%{http_code}" \
                -H "X-API-Key: ${JIRA_TOKEN}" \
                -H "Accept: application/json" \
                "${JIRA_URL}/rest/api/2/project")
            else
              RESPONSE=$(curl -s -w "\n%{http_code}" \
                -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
                -H "Accept: application/json" \
                "${JIRA_URL}/rest/api/3/project")
            fi
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            if [ "$HTTP_CODE" = "200" ]; then
              PROJECTS=$(echo "$RESPONSE" | head -n -1 | jq -r '.[].key' | tr '\n' ', ' | sed 's/,$//')
              echo "| Projects | ${PROJECTS:-None found} |" >> $GITHUB_STEP_SUMMARY
              echo "| Status | âœ… Connected |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **Note:** Set \`JIRA_PROJECT_KEY\` secret to specify the default project" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Status | âŒ Failed (HTTP ${HTTP_CODE}) |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Error:** Check your JIRA_API_TOKEN secret" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CREATE DEPLOYMENT TICKET
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ“ Create Deployment Ticket"
        if: inputs.action == 'create-deployment-ticket' || github.event.inputs.action == 'create-deployment-ticket'
        id: create
        run: |
          echo "## ðŸ“ Create Deployment Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JIRA_URL="${{ env.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"
          JIRA_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          PROJECT_KEY="${{ secrets.JIRA_PROJECT_KEY }}"
          ENV="${{ inputs.environment || github.event.inputs.environment }}"
          
          if [ -z "$JIRA_TOKEN" ] || [ -z "$PROJECT_KEY" ]; then
            echo "âš ï¸ Jira not configured - skipping ticket creation" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=MOCK-001" >> $GITHUB_OUTPUT
            echo "ticket_url=${JIRA_URL}/browse/MOCK-001" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Determine auth method: Mock Jira uses X-API-Key, Atlassian uses basic auth
          if [[ "$JIRA_URL" == *"opsera"* ]] || [[ "$JIRA_URL" == *"mock"* ]] || [ -z "$JIRA_EMAIL" ]; then
            USE_API_KEY=true
            API_VERSION="2"
          else
            USE_API_KEY=false
            API_VERSION="3"
          fi
          
          # Get commit info
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1 | sed 's/"/\\"/g')
          BRANCH="${GITHUB_REF_NAME}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          
          # Build description based on API version
          if [ "$API_VERSION" = "2" ]; then
            # API v2 uses plain text description
            DESCRIPTION="Deployment triggered for ${ENV} environment
          
          Commit: ${COMMIT_SHA}
          Branch: ${BRANCH}
          Environment: ${ENV}
          Triggered: ${TIMESTAMP}
          Workflow: ${REPO_URL}/actions/runs/${GITHUB_RUN_ID}
          
          Commit Message: ${COMMIT_MSG}"
            
            PAYLOAD="{
              \"fields\": {
                \"project\": { \"key\": \"${PROJECT_KEY}\" },
                \"summary\": \"[Deploy] ${ENV^^}: ${COMMIT_SHA} - ${{ env.APP_NAME }}\",
                \"description\": \"${DESCRIPTION}\",
                \"issuetype\": { \"name\": \"Task\" },
                \"priority\": { \"name\": \"Medium\" }
              }
            }"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "X-API-Key: ${JIRA_TOKEN}" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "${JIRA_URL}/rest/api/2/issue" \
              -d "${PAYLOAD}")
          else
            # API v3 uses Atlassian Document Format (ADF)
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "${JIRA_URL}/rest/api/3/issue" \
              -d "{
                \"fields\": {
                  \"project\": { \"key\": \"${PROJECT_KEY}\" },
                  \"summary\": \"[Deploy] ${ENV^^}: ${COMMIT_SHA} - ${{ env.APP_NAME }}\",
                  \"description\": {
                    \"type\": \"doc\",
                    \"version\": 1,
                    \"content\": [
                      {
                        \"type\": \"paragraph\",
                        \"content\": [
                          { \"type\": \"text\", \"text\": \"Deployment triggered for ${ENV} environment\" }
                        ]
                      },
                      {
                        \"type\": \"table\",
                        \"content\": [
                          {
                            \"type\": \"tableRow\",
                            \"content\": [
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"Commit\", \"marks\": [{ \"type\": \"strong\" }] }] }] },
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"${COMMIT_SHA}\" }] }] }
                            ]
                          },
                          {
                            \"type\": \"tableRow\",
                            \"content\": [
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"Branch\", \"marks\": [{ \"type\": \"strong\" }] }] }] },
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"${BRANCH}\" }] }] }
                            ]
                          },
                          {
                            \"type\": \"tableRow\",
                            \"content\": [
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"Environment\", \"marks\": [{ \"type\": \"strong\" }] }] }] },
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"${ENV}\" }] }] }
                            ]
                          },
                          {
                            \"type\": \"tableRow\",
                            \"content\": [
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"Triggered\", \"marks\": [{ \"type\": \"strong\" }] }] }] },
                              { \"type\": \"tableCell\", \"content\": [{ \"type\": \"paragraph\", \"content\": [{ \"type\": \"text\", \"text\": \"${TIMESTAMP}\" }] }] }
                            ]
                          }
                        ]
                      },
                      {
                        \"type\": \"paragraph\",
                        \"content\": [
                          { \"type\": \"text\", \"text\": \"Commit Message: \", \"marks\": [{ \"type\": \"strong\" }] },
                          { \"type\": \"text\", \"text\": \"${COMMIT_MSG}\" }
                        ]
                      }
                    ]
                  },
                  \"issuetype\": { \"name\": \"Task\" },
                  \"labels\": [\"deployment\", \"${ENV}\", \"automated\"]
                }
              }")
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          # Check for success (201 for v3, 200 or 201 for v2)
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TICKET_KEY=$(echo "$BODY" | jq -r '.key')
            TICKET_ID=$(echo "$BODY" | jq -r '.id')
            TICKET_URL="${JIRA_URL}/ui?issue=${TICKET_KEY}"
            
            echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
            echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Status | âœ… Created |" >> $GITHUB_STEP_SUMMARY
            echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Environment | ${ENV} |" >> $GITHUB_STEP_SUMMARY
            echo "| Commit | \`${COMMIT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to create ticket (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Response: \`${BODY}\`" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=" >> $GITHUB_OUTPUT
            echo "ticket_url=" >> $GITHUB_OUTPUT
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPDATE TICKET STATUS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ”„ Update Ticket Status"
        if: inputs.action == 'update-ticket' || github.event.inputs.action == 'update-ticket'
        id: update
        run: |
          echo "## ðŸ”„ Update Ticket Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JIRA_URL="${{ env.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"
          JIRA_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          TICKET_KEY="${{ inputs.ticket_key || github.event.inputs.ticket_key }}"
          STATUS="${{ inputs.status || 'Done' }}"
          
          if [ -z "$JIRA_TOKEN" ]; then
            echo "âš ï¸ Jira not configured - skipping update" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          if [ -z "$TICKET_KEY" ]; then
            echo "âŒ No ticket key provided" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Determine auth method
          if [[ "$JIRA_URL" == *"opsera"* ]] || [[ "$JIRA_URL" == *"mock"* ]] || [ -z "$JIRA_EMAIL" ]; then
            USE_API_KEY=true
            API_VERSION="2"
          else
            USE_API_KEY=false
            API_VERSION="3"
          fi
          
          # Get available transitions
          if [ "$USE_API_KEY" = true ]; then
            TRANSITIONS=$(curl -s \
              -H "X-API-Key: ${JIRA_TOKEN}" \
              -H "Accept: application/json" \
              "${JIRA_URL}/rest/api/2/issue/${TICKET_KEY}/transitions")
          else
            TRANSITIONS=$(curl -s \
              -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
              -H "Accept: application/json" \
              "${JIRA_URL}/rest/api/3/issue/${TICKET_KEY}/transitions")
          fi
          
          # Find transition ID for target status
          TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r ".transitions[] | select(.name | ascii_downcase == \"${STATUS}\" | ascii_downcase) | .id" 2>/dev/null | head -1)
          
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            # Try common status names
            case "${STATUS,,}" in
              "done"|"complete"|"completed")
                TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name | test("done|complete|closed"; "i")) | .id' 2>/dev/null | head -1)
                ;;
              "in progress"|"in-progress")
                TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name | test("progress|started"; "i")) | .id' 2>/dev/null | head -1)
                ;;
              "failed"|"rejected")
                TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.name | test("failed|rejected|cancelled"; "i")) | .id' 2>/dev/null | head -1)
                ;;
            esac
          fi
          
          TICKET_URL="${JIRA_URL}/ui?issue=${TICKET_KEY}"
          
          if [ -n "$TRANSITION_ID" ] && [ "$TRANSITION_ID" != "null" ]; then
            # Execute transition
            if [ "$USE_API_KEY" = true ]; then
              curl -s -X POST \
                -H "X-API-Key: ${JIRA_TOKEN}" \
                -H "Content-Type: application/json" \
                "${JIRA_URL}/rest/api/2/issue/${TICKET_KEY}/transitions" \
                -d "{ \"transition\": { \"id\": \"${TRANSITION_ID}\" } }"
            else
              curl -s -X POST \
                -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
                -H "Content-Type: application/json" \
                "${JIRA_URL}/rest/api/3/issue/${TICKET_KEY}/transitions" \
                -d "{ \"transition\": { \"id\": \"${TRANSITION_ID}\" } }"
            fi
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| New Status | ${STATUS} |" >> $GITHUB_STEP_SUMMARY
            echo "| Result | âœ… Updated |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Could not find transition for status: ${STATUS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Available transitions:" >> $GITHUB_STEP_SUMMARY
            echo "$TRANSITIONS" | jq -r '.transitions[] | "- \(.name)"' 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "- None available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
          echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LINK COMMIT TO TICKET
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ”— Link Commit to Ticket"
        if: inputs.action == 'link-commit' || github.event.inputs.action == 'link-commit'
        run: |
          echo "## ðŸ”— Link Commit to Jira" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JIRA_URL="${{ env.JIRA_BASE_URL }}"
          JIRA_EMAIL="${{ secrets.JIRA_USER_EMAIL }}"
          JIRA_TOKEN="${{ secrets.JIRA_API_TOKEN }}"
          TICKET_KEY="${{ inputs.ticket_key || github.event.inputs.ticket_key }}"
          
          if [ -z "$JIRA_TOKEN" ]; then
            echo "âš ï¸ Jira not configured - skipping link" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          if [ -z "$TICKET_KEY" ]; then
            # Try to extract from commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            TICKET_KEY=$(echo "$COMMIT_MSG" | grep -oE '[A-Z]+-[0-9]+' | head -1)
            
            if [ -z "$TICKET_KEY" ]; then
              echo "âš ï¸ No ticket key found in commit message" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "To auto-link commits, include ticket key in commit message:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "git commit -m \"PR1-123: Fix button color\"" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          fi
          
          # Determine auth method
          if [[ "$JIRA_URL" == *"opsera"* ]] || [[ "$JIRA_URL" == *"mock"* ]] || [ -z "$JIRA_EMAIL" ]; then
            USE_API_KEY=true
            API_VERSION="2"
          else
            USE_API_KEY=false
            API_VERSION="3"
          fi
          
          COMMIT_SHA="${GITHUB_SHA}"
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1 | sed 's/"/\\"/g')
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          TICKET_URL="${JIRA_URL}/ui?issue=${TICKET_KEY}"
          
          # Add comment with commit link
          if [ "$USE_API_KEY" = true ]; then
            COMMENT_BODY="Commit linked: ${COMMIT_SHA:0:7}
          
          Commit URL: ${REPO_URL}/commit/${COMMIT_SHA}
          Message: ${COMMIT_MSG}"
            
            curl -s -X POST \
              -H "X-API-Key: ${JIRA_TOKEN}" \
              -H "Content-Type: application/json" \
              "${JIRA_URL}/rest/api/2/issue/${TICKET_KEY}/comment" \
              -d "{\"body\": \"${COMMENT_BODY}\"}"
          else
            curl -s -X POST \
              -u "${JIRA_EMAIL}:${JIRA_TOKEN}" \
              -H "Content-Type: application/json" \
              "${JIRA_URL}/rest/api/3/issue/${TICKET_KEY}/comment" \
              -d "{
                \"body\": {
                  \"type\": \"doc\",
                  \"version\": 1,
                  \"content\": [
                    {
                      \"type\": \"paragraph\",
                      \"content\": [
                        { \"type\": \"text\", \"text\": \"Commit linked: \" },
                        { \"type\": \"text\", \"text\": \"${COMMIT_SHA:0:7}\", \"marks\": [{ \"type\": \"link\", \"attrs\": { \"href\": \"${REPO_URL}/commit/${COMMIT_SHA}\" } }] }
                      ]
                    },
                    {
                      \"type\": \"paragraph\",
                      \"content\": [
                        { \"type\": \"text\", \"text\": \"Message: ${COMMIT_MSG}\" }
                      ]
                    }
                  ]
                }
              }"
          fi
          
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | [\`${COMMIT_SHA:0:7}\`](${REPO_URL}/commit/${COMMIT_SHA}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Linked |" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GENERATE RELEASE NOTES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ“‹ Generate Release Notes"
        if: inputs.action == 'generate-release-notes' || github.event.inputs.action == 'generate-release-notes'
        run: |
          echo "## ðŸ“‹ Release Notes Generator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VERSION="${{ inputs.version || github.event.inputs.version }}"
          JIRA_URL="${{ env.JIRA_BASE_URL }}"
          
          if [ -z "$VERSION" ]; then
            # Use latest tag or generate from date
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v$(date +%Y.%m.%d)")
          fi
          
          echo "### Release: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$LAST_TAG" ]; then
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          else
            COMMIT_RANGE="HEAD~10..HEAD"
          fi
          
          echo "**Changes since ${LAST_TAG:-initial commit}:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Categorize commits
          echo "#### Features" >> $GITHUB_STEP_SUMMARY
          git log ${COMMIT_RANGE} --oneline --grep="feat" --grep="feature" --grep="add" | head -10 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- No new features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Bug Fixes" >> $GITHUB_STEP_SUMMARY
          git log ${COMMIT_RANGE} --oneline --grep="fix" --grep="bug" | head -10 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- No bug fixes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Other Changes" >> $GITHUB_STEP_SUMMARY
          git log ${COMMIT_RANGE} --oneline | grep -v -E "feat|fix|bug|feature|add" | head -10 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- No other changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract Jira tickets
          echo "#### Linked Jira Tickets" >> $GITHUB_STEP_SUMMARY
          TICKETS=$(git log ${COMMIT_RANGE} --oneline | grep -oE '[A-Z]+-[0-9]+' | sort -u)
          
          if [ -n "$TICKETS" ]; then
            for TICKET in $TICKETS; do
              echo "- [${TICKET}](${JIRA_URL}/ui?issue=${TICKET})" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No Jira tickets found in commit messages" >> $GITHUB_STEP_SUMMARY
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # OUTPUT STEP (for workflow_call)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Set Outputs
        id: action
        if: always()
        run: |
          # Aggregate outputs from previous steps
          TICKET_KEY="${{ steps.create.outputs.ticket_key || steps.update.outputs.ticket_key || '' }}"
          TICKET_URL="${{ steps.create.outputs.ticket_url || steps.update.outputs.ticket_url || '' }}"
          
          echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
          echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT
