# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    ENTERPRISE CI/CD PIPELINE - BUILD STAGE                    â•‘
# â•‘                                                                                â•‘
# â•‘  This workflow handles the build stage of the CI/CD pipeline:                 â•‘
# â•‘  â€¢ Builds Docker images for all services (parallel)                           â•‘
# â•‘  â€¢ Pushes to AWS ECR                                                          â•‘
# â•‘  â€¢ Triggers downstream security scanning                                      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”¨ CI: Build Images"

on:
  push:
    branches: [main]
    paths:
      - 'vote/**'
      - 'result/**'
      - 'worker/**'
      - '.opsera-voting-app/Dockerfile.*'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated or "all")'
        required: true
        default: 'all'
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app

permissions:
  contents: write
  id-token: write

jobs:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ PREPARE: Generate build metadata                                             â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  prepare:
    name: "ðŸ“‹ Prepare Build"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
      ecr_uri: ${{ steps.ecr.outputs.ecr_uri }}
      build_vote: ${{ steps.changes.outputs.vote }}
      build_result: ${{ steps.changes.outputs.result }}
      build_worker: ${{ steps.changes.outputs.worker }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate Image Tag
        id: tag
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "### ðŸ·ï¸ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${GITHUB_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${GITHUB_REF_NAME}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR URI
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT

      - name: Detect Changes
        id: changes
        run: |
          SERVICES="${{ github.event.inputs.services || 'all' }}"
          
          if [ "$SERVICES" = "all" ] || [ "${{ github.event_name }}" = "push" ]; then
            # Check which directories changed
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "vote result worker")
            
            echo "vote=$(echo "$CHANGED" | grep -q 'vote/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "result=$(echo "$CHANGED" | grep -q 'result/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "worker=$(echo "$CHANGED" | grep -q 'worker/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            
            # If Dockerfile changed, rebuild all
            if echo "$CHANGED" | grep -q 'Dockerfile'; then
              echo "vote=true" >> $GITHUB_OUTPUT
              echo "result=true" >> $GITHUB_OUTPUT
              echo "worker=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "vote=$(echo "$SERVICES" | grep -q 'vote' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "result=$(echo "$SERVICES" | grep -q 'result' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "worker=$(echo "$SERVICES" | grep -q 'worker' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

      - name: Ensure ECR Repositories
        run: |
          for SERVICE in vote result worker; do
            aws ecr describe-repositories --repository-names "$SERVICE" 2>/dev/null || \
            aws ecr create-repository \
              --repository-name "$SERVICE" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
          done

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ BUILD: Parallel image builds                                                 â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  build-vote:
    name: "ðŸ—³ï¸ Build Vote"
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.build_vote == 'true' || github.event.inputs.services == 'all'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Vote Image
        env:
          ECR_URI: ${{ needs.prepare.outputs.ecr_uri }}
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
        run: |
          FULL_IMAGE="${ECR_URI}/vote:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_URI}/vote:latest"
          
          echo "### ðŸ—³ï¸ Vote Service Build" >> $GITHUB_STEP_SUMMARY
          echo "Building: \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          
          docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
            -f .opsera-voting-app/Dockerfile.vote .
          
          docker push "$FULL_IMAGE"
          docker push "$LATEST_IMAGE"
          
          echo "âœ… Successfully pushed to ECR" >> $GITHUB_STEP_SUMMARY

  build-result:
    name: "ðŸ“Š Build Result"
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.build_result == 'true' || github.event.inputs.services == 'all'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Result Image
        env:
          ECR_URI: ${{ needs.prepare.outputs.ecr_uri }}
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
        run: |
          FULL_IMAGE="${ECR_URI}/result:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_URI}/result:latest"
          
          echo "### ðŸ“Š Result Service Build" >> $GITHUB_STEP_SUMMARY
          echo "Building: \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          
          docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
            -f .opsera-voting-app/Dockerfile.result .
          
          docker push "$FULL_IMAGE"
          docker push "$LATEST_IMAGE"
          
          echo "âœ… Successfully pushed to ECR" >> $GITHUB_STEP_SUMMARY

  build-worker:
    name: "âš™ï¸ Build Worker"
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.build_worker == 'true' || github.event.inputs.services == 'all'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Worker Image
        env:
          ECR_URI: ${{ needs.prepare.outputs.ecr_uri }}
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
        run: |
          FULL_IMAGE="${ECR_URI}/worker:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_URI}/worker:latest"
          
          echo "### âš™ï¸ Worker Service Build" >> $GITHUB_STEP_SUMMARY
          echo "Building: \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          
          docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
            -f .opsera-voting-app/Dockerfile.worker .
          
          docker push "$FULL_IMAGE"
          docker push "$LATEST_IMAGE"
          
          echo "âœ… Successfully pushed to ECR" >> $GITHUB_STEP_SUMMARY

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ SUMMARY: Build completion report                                             â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  build-summary:
    name: "ðŸ“ Build Summary"
    runs-on: ubuntu-latest
    needs: [prepare, build-vote, build-result, build-worker]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”¨ Build Stage Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          [ "${{ needs.build-vote.result }}" = "success" ] && V="âœ… Built" || V="â­ï¸ Skipped"
          [ "${{ needs.build-result.result }}" = "success" ] && R="âœ… Built" || R="â­ï¸ Skipped"
          [ "${{ needs.build-worker.result }}" = "success" ] && W="âœ… Built" || W="â­ï¸ Skipped"
          
          echo "| Vote | ${V} |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${R} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${W} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.prepare.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
