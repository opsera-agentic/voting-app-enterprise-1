name: "Sync ArgoCD Application"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
      refresh_hard:
        description: 'Force hard refresh'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  APP_NAME: voting-app

permissions:
  contents: read
  id-token: write

jobs:
  sync:
    name: "Sync ${{ github.event.inputs.environment }}"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Refresh ArgoCD Application
        if: ${{ github.event.inputs.refresh_hard == 'true' }}
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          echo "ðŸ”„ Triggering hard refresh for ${APP}..."
          kubectl annotate application "${APP}" -n argocd argocd.argoproj.io/refresh=hard --overwrite
          sleep 5

      - name: Sync ArgoCD Application
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          echo "ðŸš€ Syncing ${APP}..."
          
          # Trigger sync operation
          kubectl patch application "${APP}" -n argocd --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true,"syncStrategy":{"apply":{"force":false}}}}}'
          
          echo "â³ Waiting for sync to complete..."
          sleep 10

      - name: Wait for Sync Completion
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          echo "â³ Monitoring sync status..."
          
          for i in {1..30}; do
            SYNC_STATUS=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH_STATUS=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
            OPERATION_PHASE=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.operationState.phase}' 2>/dev/null || echo "")
            
            echo "  [$i/30] Sync: ${SYNC_STATUS}, Health: ${HEALTH_STATUS}, Operation: ${OPERATION_PHASE}"
            
            # Check if sync is complete
            if [ "$OPERATION_PHASE" = "Succeeded" ] || [ "$OPERATION_PHASE" = "Failed" ] || [ -z "$OPERATION_PHASE" ]; then
              if [ "$SYNC_STATUS" = "Synced" ]; then
                echo "âœ… Sync completed successfully!"
                break
              fi
            fi
            
            sleep 10
          done

      - name: Get Application Status
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          
          echo "## ðŸ“Š ArgoCD Application Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get status
          SYNC_STATUS=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.sync.status}')
          HEALTH_STATUS=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.health.status}')
          REVISION=$(kubectl get application "${APP}" -n argocd -o jsonpath='{.status.sync.revision}')
          
          case "$HEALTH_STATUS" in
            "Healthy") HEALTH_EMOJI="ðŸŸ¢" ;;
            "Progressing") HEALTH_EMOJI="ðŸ”µ" ;;
            "Degraded") HEALTH_EMOJI="ðŸ”´" ;;
            *) HEALTH_EMOJI="âšª" ;;
          esac
          
          case "$SYNC_STATUS" in
            "Synced") SYNC_EMOJI="âœ…" ;;
            "OutOfSync") SYNC_EMOJI="âš ï¸" ;;
            *) SYNC_EMOJI="â“" ;;
          esac
          
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Application** | ${APP} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Sync Status** | ${SYNC_EMOJI} ${SYNC_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Health Status** | ${HEALTH_EMOJI} ${HEALTH_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Revision** | \`${REVISION:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Rollout Status (QA Only)
        if: ${{ github.event.inputs.environment == 'qa' }}
        run: |
          # Connect to spoke cluster
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NAMESPACE="${{ env.APP_NAME }}-qa"
          
          echo "## ðŸ¤ Rollout Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Rollout | Phase | Message |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|---------|" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in vote-rollout result-rollout; do
            if kubectl get rollout "${ROLLOUT}" -n "${NAMESPACE}" &>/dev/null; then
              PHASE=$(kubectl get rollout "${ROLLOUT}" -n "${NAMESPACE}" -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
              MESSAGE=$(kubectl get rollout "${ROLLOUT}" -n "${NAMESPACE}" -o jsonpath='{.status.message}' 2>/dev/null | head -c 60 || echo "")
              
              case "$PHASE" in
                "Healthy") EMOJI="ðŸŸ¢" ;;
                "Progressing") EMOJI="ðŸ”µ" ;;
                "Degraded") EMOJI="ðŸ”´" ;;
                *) EMOJI="âšª" ;;
              esac
              
              echo "| ${ROLLOUT} | ${EMOJI} ${PHASE} | ${MESSAGE:-OK} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${ROLLOUT} | âšª Not Found | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Pods Status
        run: |
          # Connect to spoke cluster
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          
          echo "## ðŸƒ Pod Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "${NAMESPACE}" -o wide 2>/dev/null || echo "Namespace not found or no pods"
          kubectl get pods -n "${NAMESPACE}" -o wide >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No pods found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
