# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ARCHITECTURE DIAGRAM GENERATOR - Enterprise Edition                          â•‘
# â•‘                                                                                â•‘
# â•‘  Generates professional deployment architecture diagrams:                      â•‘
# â•‘  â€¢ White background with clean styling                                         â•‘
# â•‘  â€¢ Service icons and numbered flow                                             â•‘
# â•‘  â€¢ Kubernetes resource topology                                                â•‘
# â•‘  â€¢ CI/CD pipeline visualization                                                â•‘
# â•‘  â€¢ Sequence diagrams for deployment flows                                      â•‘
# â•‘  â€¢ Data flow diagrams                                                          â•‘
# â•‘                                                                                â•‘
# â•‘  Output: Mermaid diagrams in GitHub Actions Summary                            â•‘
# â•‘  Powered by Opsera - The Unified DevOps Platform                               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸŽ¨ Ops: Architecture Diagram"

on:
  workflow_dispatch:
    inputs:
      diagram_type:
        description: 'Diagram type'
        required: true
        type: choice
        options:
          - all
          - deployment-architecture
          - kubernetes-topology
          - ci-cd-pipeline
          - sequence-diagram
          - data-flow
        default: 'all'
      environment:
        description: 'Environment to visualize'
        required: true
        type: choice
        options:
          - all
          - dev
          - qa
        default: 'all'
  
  # Can be called by other workflows
  workflow_call:
    inputs:
      diagram_type:
        description: 'Diagram type'
        required: false
        type: string
        default: 'all'
      environment:
        description: 'Environment to visualize'
        required: false
        type: string
        default: 'all'
      image_tag:
        description: 'Current image tag'
        required: false
        type: string
        default: 'latest'

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2
  APP_NAME: voting-app
  DEV_URL: https://opsera-voting-app-dev.agent.opsera.dev
  QA_URL: https://opsera-voting-app-qa.agent.opsera.dev

permissions:
  contents: read
  id-token: write

jobs:
  generate-diagrams:
    name: "ðŸŽ¨ Generate Architecture Diagrams"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} || true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # HEADER
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ“‹ Generate Header"
        run: |
          DIAGRAM_TYPE="${{ inputs.diagram_type || github.event.inputs.diagram_type || 'all' }}"
          
          echo "# ðŸ—ï¸ Voting App Architecture Diagrams" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Diagram Type:** ${DIAGRAM_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOYMENT ARCHITECTURE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ—ï¸ Generate Deployment Architecture"
        if: inputs.diagram_type == 'deployment-architecture' || inputs.diagram_type == 'all' || github.event.inputs.diagram_type == 'deployment-architecture' || github.event.inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ—ï¸ System Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Enterprise deployment architecture with numbered flow showing the complete request path from users to backend services." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'ARCH'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4285f4', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#1a73e8', 'lineColor': '#5f6368', 'secondaryColor': '#f8f9fa', 'tertiaryColor': '#ffffff', 'background': '#ffffff', 'mainBkg': '#ffffff', 'nodeBorder': '#dadce0'}}}%%
flowchart TB
    %% Styling
    classDef userStyle fill:#e8f0fe,stroke:#1a73e8,stroke-width:2px,color:#1a1a1a
    classDef awsStyle fill:#ff9900,stroke:#232f3e,stroke-width:2px,color:#232f3e
    classDef k8sStyle fill:#326ce5,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef appStyle fill:#4285f4,stroke:#1a73e8,stroke-width:2px,color:#ffffff
    classDef dataStyle fill:#34a853,stroke:#1e8e3e,stroke-width:2px,color:#ffffff
    classDef cicdStyle fill:#9334e6,stroke:#7627bb,stroke-width:2px,color:#ffffff
    classDef monitorStyle fill:#ea4335,stroke:#c5221f,stroke-width:2px,color:#ffffff

    subgraph INTERNET["â˜ï¸ Internet"]
        USER["ðŸ‘¤ End Users"]
    end

    subgraph AWS["â˜ï¸ AWS Cloud (us-west-2)"]
        subgraph DNS["ðŸŒ Route 53"]
            R53_DEV["ðŸ“ opsera-voting-app-dev\n.agent.opsera.dev"]
            R53_QA["ðŸ“ opsera-voting-app-qa\n.agent.opsera.dev"]
        end

        subgraph EKS["âŽˆ Amazon EKS Cluster"]
            subgraph INGRESS_NS["Namespace: ingress-nginx"]
                ALB["ðŸ”· Application Load Balancer"]
                NGINX["ðŸ”· NGINX Ingress Controller\n+ cert-manager (TLS)"]
            end

            subgraph DEV_NS["Namespace: voting-app-dev"]
                direction TB
                VOTE_DEV["ðŸ—³ï¸ Vote Service\nPython Flask\n2 replicas"]
                RESULT_DEV["ðŸ“Š Result Service\nNode.js Express\n2 replicas"]
                WORKER_DEV["âš™ï¸ Worker Service\n.NET Core\n1 replica"]
                REDIS_DEV[("ðŸ”´ Redis\nIn-Memory Queue\n1 replica")]
                PG_DEV[("ðŸ˜ PostgreSQL\nPersistent Storage\n1 replica")]
            end

            subgraph QA_NS["Namespace: voting-app-qa"]
                direction TB
                subgraph CANARY_BOX["ðŸ¤ Argo Rollouts - Canary"]
                    VOTE_STABLE["ðŸ—³ï¸ Vote (Stable)\n90% traffic"]
                    VOTE_CANARY["ðŸ—³ï¸ Vote (Canary)\n10% traffic"]
                end
                RESULT_QA["ðŸ“Š Result Service\n2 replicas"]
                WORKER_QA["âš™ï¸ Worker Service\n1 replica"]
                REDIS_QA[("ðŸ”´ Redis\n1 replica")]
                PG_QA[("ðŸ˜ PostgreSQL\n1 replica")]
            end

            subgraph PLATFORM_NS["Platform Services"]
                ARGOCD["ðŸ”„ ArgoCD\nGitOps Controller"]
                ROLLOUTS["ðŸ“ˆ Argo Rollouts\nProgressive Delivery"]
                EXTDNS["ðŸ“ ExternalDNS\nRoute53 Automation"]
                CERTMGR["ðŸ” cert-manager\nTLS Certificates"]
            end
        end

        subgraph ECR_BOX["ðŸ“¦ Amazon ECR"]
            ECR_VOTE["ðŸ“¦ vote:tag"]
            ECR_RESULT["ðŸ“¦ result:tag"]
            ECR_WORKER["ðŸ“¦ worker:tag"]
        end
    end

    subgraph GITHUB["ðŸ™ GitHub"]
        REPO["ðŸ“‚ Source Repository"]
        GHA["âš¡ GitHub Actions\nCI/CD Pipeline"]
    end

    subgraph INTEGRATIONS["ðŸ”Œ Integrations"]
        NR["ðŸ“ˆ New Relic\nAPM & Metrics"]
        SLACK["ðŸ’¬ Slack\nNotifications"]
        JIRA["ðŸŽ« Jira\nTicket Tracking"]
    end

    %% Numbered Flow - User Request Path
    USER -->|"1ï¸âƒ£ HTTPS"| R53_DEV & R53_QA
    R53_DEV & R53_QA -->|"2ï¸âƒ£ DNS Resolution"| ALB
    ALB -->|"3ï¸âƒ£ TLS Termination"| NGINX
    NGINX -->|"4ï¸âƒ£ Route /vote"| VOTE_DEV
    NGINX -->|"4ï¸âƒ£ Route /vote"| VOTE_STABLE & VOTE_CANARY
    NGINX -->|"4ï¸âƒ£ Route /result"| RESULT_DEV & RESULT_QA

    %% Application Data Flow
    VOTE_DEV -->|"5ï¸âƒ£ LPUSH"| REDIS_DEV
    VOTE_STABLE & VOTE_CANARY -->|"5ï¸âƒ£ LPUSH"| REDIS_QA
    REDIS_DEV -->|"6ï¸âƒ£ RPOP"| WORKER_DEV
    REDIS_QA -->|"6ï¸âƒ£ RPOP"| WORKER_QA
    WORKER_DEV -->|"7ï¸âƒ£ UPSERT"| PG_DEV
    WORKER_QA -->|"7ï¸âƒ£ UPSERT"| PG_QA
    PG_DEV -->|"8ï¸âƒ£ SELECT"| RESULT_DEV
    PG_QA -->|"8ï¸âƒ£ SELECT"| RESULT_QA

    %% CI/CD Flow
    REPO -->|"9ï¸âƒ£ git push"| GHA
    GHA -->|"ðŸ”Ÿ docker build/push"| ECR_VOTE & ECR_RESULT & ECR_WORKER
    GHA -->|"1ï¸âƒ£1ï¸âƒ£ sync"| ARGOCD
    ARGOCD -->|"1ï¸âƒ£2ï¸âƒ£ deploy"| DEV_NS & QA_NS
    ROLLOUTS -->|"1ï¸âƒ£3ï¸âƒ£ canary mgmt"| CANARY_BOX

    %% Monitoring
    DEV_NS & QA_NS -.->|"metrics"| NR
    GHA -.->|"notify"| SLACK
    GHA -.->|"track"| JIRA
    NR -.->|"analysis"| ROLLOUTS

    %% Apply Styles
    class USER userStyle
    class AWS,DNS,ECR_BOX awsStyle
    class EKS,INGRESS_NS,DEV_NS,QA_NS,PLATFORM_NS k8sStyle
    class VOTE_DEV,RESULT_DEV,WORKER_DEV,VOTE_STABLE,VOTE_CANARY,RESULT_QA,WORKER_QA appStyle
    class REDIS_DEV,PG_DEV,REDIS_QA,PG_QA dataStyle
    class GITHUB,REPO,GHA cicdStyle
    class NR,SLACK,JIRA monitorStyle
```
ARCH

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CI/CD PIPELINE DIAGRAM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ”„ Generate CI/CD Pipeline Diagram"
        if: inputs.diagram_type == 'ci-cd-pipeline' || inputs.diagram_type == 'all' || github.event.inputs.diagram_type == 'ci-cd-pipeline' || github.event.inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”„ CI/CD Pipeline Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Enterprise CI/CD pipeline with 6 stages: Bootstrap, Test & Scan, Build, Deploy DEV, Promote QA, and Canary." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'PIPELINE'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4285f4', 'background': '#ffffff', 'lineColor': '#5f6368'}}}%%
flowchart LR
    subgraph S0["ðŸ—ï¸ Stage 0: Bootstrap"]
        B0["00-bootstrap\ninfrastructure"]
    end

    subgraph S1["ðŸ” Stage 1: Test & Scan"]
        direction TB
        T1["ðŸ” SAST\n(Semgrep)"]
        T2["ðŸ“¦ SCA\n(Trivy)"]
        T3["ðŸ” Secrets\n(Gitleaks)"]
        T4["ðŸ“ Lint"]
        T5["ðŸ§ª Unit Tests"]
        T6{"ðŸš¦ Quality\nGate"}
    end

    subgraph S2["ðŸ”¨ Stage 2: Build"]
        direction TB
        B1["ðŸ Build Vote\n(Python)"]
        B2["ðŸ“Š Build Result\n(Node.js)"]
        B3["âš™ï¸ Build Worker\n(.NET)"]
        B4["ðŸ” Container Scan\n(Anchore/Grype)"]
        B5["ðŸ“¤ Push to ECR"]
    end

    subgraph S3["ðŸš€ Stage 3: Deploy DEV"]
        direction TB
        D1["ðŸŽ« Create Jira Ticket"]
        D2["ðŸ”Ž Pre-deploy Check"]
        D3["ðŸ“ Update Manifests"]
        D4["ðŸ”„ ArgoCD Sync"]
        D5["âœ… Verify Health"]
        D6["ðŸ§ª Smoke Tests"]
        D7["ðŸ—ï¸ Architecture Diagram"]
    end

    subgraph S4["â¬†ï¸ Stage 4: Promote QA"]
        direction TB
        Q0{"â¸ï¸ Approval\nGate"}
        Q1["ðŸŽ« Create Jira Ticket"]
        Q2["ðŸ“ Update Manifests"]
        Q3["ðŸ”„ ArgoCD Sync"]
    end

    subgraph S5["ðŸ¤ Stage 5: Canary"]
        direction TB
        C1["ðŸ“Š 10% Traffic"]
        C2["ðŸ“Š 30% Traffic"]
        C3["ðŸ“Š 60% Traffic"]
        C4["ðŸ“Š 100% Traffic"]
        C5{"ðŸ“ˆ New Relic\nAnalysis"}
    end

    subgraph NOTIFY["ðŸ“¢ Notifications"]
        N1["ðŸ’¬ Slack"]
        N2["ðŸŽ« Jira Update"]
    end

    %% Connections
    B0 --> T1 & T2 & T3 & T4 & T5
    T1 & T2 & T3 & T4 & T5 --> T6
    T6 -->|"âœ… Pass"| B1 & B2 & B3
    T6 -->|"âŒ Fail"| N1
    B1 & B2 & B3 --> B4
    B4 --> B5
    B5 --> D1
    D1 --> D2 --> D3 --> D4 --> D5 --> D6 --> D7
    D7 --> Q0
    Q0 -->|"âœ… Approved"| Q1
    Q0 -->|"âŒ Rejected"| N1
    Q1 --> Q2 --> Q3
    Q3 --> C1
    C1 --> C5
    C5 -->|"âœ… Healthy"| C2
    C5 -->|"âŒ Unhealthy"| N1
    C2 --> C3 --> C4
    C4 --> N1 & N2

    style S0 fill:#e8f0fe,stroke:#1a73e8
    style S1 fill:#fce8e6,stroke:#ea4335
    style S2 fill:#e6f4ea,stroke:#34a853
    style S3 fill:#e8f0fe,stroke:#1a73e8
    style S4 fill:#fef7e0,stroke:#fbbc04
    style S5 fill:#f3e8fd,stroke:#9334e6
    style NOTIFY fill:#f1f3f4,stroke:#5f6368
```
PIPELINE

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SEQUENCE DIAGRAM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ“ Generate Sequence Diagram"
        if: inputs.diagram_type == 'sequence-diagram' || inputs.diagram_type == 'all' || github.event.inputs.diagram_type == 'sequence-diagram' || github.event.inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Deployment Sequence Diagram" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Step-by-step sequence showing all interactions during a deployment, from code push to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'SEQ'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'actorBkg': '#4285f4', 'actorTextColor': '#ffffff', 'actorLineColor': '#5f6368', 'signalColor': '#1a73e8', 'signalTextColor': '#1a1a1a'}}}%%
sequenceDiagram
    autonumber
    
    participant DEV as ðŸ‘¨â€ðŸ’» Developer
    participant GH as ðŸ™ GitHub
    participant GHA as âš¡ GitHub Actions
    participant SCAN as ðŸ” Security Scanners
    participant JIRA as ðŸŽ« Jira
    participant ECR as ðŸ“¦ Amazon ECR
    participant ARGO as ðŸ”„ ArgoCD
    participant K8S as âŽˆ Kubernetes
    participant APP as ðŸ—³ï¸ Application
    participant NR as ðŸ“ˆ New Relic
    participant SLACK as ðŸ’¬ Slack

    rect rgb(232, 240, 254)
        Note over DEV,GH: 1ï¸âƒ£ Code Commit Phase
        DEV->>GH: git push (feature branch)
        GH->>GHA: Trigger CI workflow
    end

    rect rgb(252, 232, 230)
        Note over GHA,SCAN: 2ï¸âƒ£ Security Scan Phase
        par Parallel Scanning
            GHA->>SCAN: Run SAST (Semgrep)
            GHA->>SCAN: Run SCA (Trivy)
            GHA->>SCAN: Run Secret Scan (Gitleaks)
        end
        SCAN-->>GHA: Scan Results
        GHA->>GHA: Evaluate Quality Gate
        alt Gate Failed
            GHA->>SLACK: âŒ Build failed notification
        end
    end

    rect rgb(230, 244, 234)
        Note over GHA,ECR: 3ï¸âƒ£ Build & Push Phase
        par Parallel Builds
            GHA->>GHA: Build vote image
            GHA->>GHA: Build result image
            GHA->>GHA: Build worker image
        end
        GHA->>SCAN: Container vulnerability scan
        GHA->>ECR: Push images with tag
    end

    rect rgb(232, 240, 254)
        Note over GHA,K8S: 4ï¸âƒ£ Deploy to DEV Phase
        GHA->>JIRA: Create deployment ticket
        JIRA-->>GHA: Ticket: PR1-XXX
        GHA->>GH: Update Kustomize manifests
        GHA->>ARGO: Trigger sync
        ARGO->>GH: Pull latest manifests
        ARGO->>K8S: Apply Kubernetes resources
        K8S->>ECR: Pull new images
        K8S->>APP: Rolling update pods
        GHA->>JIRA: Update: Deployed to DEV
        GHA->>SLACK: âœ… DEV deployment complete
    end

    rect rgb(254, 247, 224)
        Note over DEV,GHA: 5ï¸âƒ£ Approval Phase
        GHA->>SLACK: ðŸš¦ Request QA approval
        SLACK-->>DEV: Notification
        DEV->>GHA: âœ… Approve promotion
        GHA->>JIRA: Create promotion ticket
    end

    rect rgb(243, 232, 253)
        Note over GHA,NR: 6ï¸âƒ£ Canary Deployment Phase
        GHA->>ARGO: Update QA manifests
        ARGO->>K8S: Deploy canary (10%)
        
        loop Canary Analysis (10% â†’ 30% â†’ 60% â†’ 100%)
            K8S->>APP: Route traffic to canary
            APP->>NR: Send metrics (error rate, latency)
            NR-->>ARGO: Analysis result
            alt Metrics Healthy
                ARGO->>K8S: Increase canary weight
            else Metrics Unhealthy
                ARGO->>K8S: Rollback to stable
                ARGO->>SLACK: âš ï¸ Canary failed
                ARGO->>JIRA: Update: Rollback triggered
            end
        end
        
        ARGO->>K8S: Promote canary to stable
        ARGO->>JIRA: âœ… QA deployment complete
        ARGO->>SLACK: âœ… Canary promotion successful
    end

    rect rgb(241, 243, 244)
        Note over GHA,SLACK: 7ï¸âƒ£ Completion Phase
        GHA->>GHA: Generate architecture diagram
        GHA->>JIRA: Close deployment ticket
        GHA->>SLACK: ðŸ“Š Deployment summary
    end
```
SEQ

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DATA FLOW DIAGRAM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ”€ Generate Data Flow Diagram"
        if: inputs.diagram_type == 'data-flow' || inputs.diagram_type == 'all' || github.event.inputs.diagram_type == 'data-flow' || github.event.inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”€ Application Data Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Data flow through the voting application, from user vote submission to results display." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'DATA'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff'}}}%%
flowchart LR
    subgraph CLIENT["ðŸ‘¤ Client"]
        BROWSER["ðŸŒ Web Browser"]
    end

    subgraph VOTE_FLOW["ðŸ—³ï¸ Voting Flow"]
        direction TB
        V1["1ï¸âƒ£ Visit vote.domain.com"]
        V2["2ï¸âƒ£ Display vote options\n(Cats vs Dogs)"]
        V3["3ï¸âƒ£ User clicks vote button"]
        V4["4ï¸âƒ£ POST /vote\n{voter_id, vote}"]
    end

    subgraph BACKEND["âš™ï¸ Backend Services"]
        direction TB
        
        subgraph VOTE_SVC["ðŸ Vote Service (Flask)"]
            VS1["Receive HTTP POST"]
            VS2["Generate voter_id cookie"]
            VS3["LPUSH to Redis queue"]
        end
        
        subgraph REDIS_Q["ðŸ”´ Redis"]
            RQ[("votes queue\nLIST type")]
        end
        
        subgraph WORKER_SVC["ðŸ”§ Worker (.NET)"]
            WS1["RPOP from queue"]
            WS2["Parse vote data"]
            WS3["UPSERT to PostgreSQL"]
        end
        
        subgraph PG_DB["ðŸ˜ PostgreSQL"]
            DB[("votes table\nid | vote")]
        end
        
        subgraph RESULT_SVC["ðŸ“Š Result Service (Node.js)"]
            RS1["SELECT COUNT(*)\nGROUP BY vote"]
            RS2["Calculate percentages"]
            RS3["WebSocket broadcast"]
        end
    end

    subgraph RESULT_FLOW["ðŸ“Š Results Flow"]
        direction TB
        R1["5ï¸âƒ£ Visit results.domain.com"]
        R2["6ï¸âƒ£ WebSocket connection"]
        R3["7ï¸âƒ£ Real-time updates"]
        R4["8ï¸âƒ£ Display percentages"]
    end

    %% Connections
    BROWSER --> V1 --> V2 --> V3 --> V4
    V4 --> VS1 --> VS2 --> VS3
    VS3 -->|"LPUSH"| RQ
    RQ -->|"RPOP"| WS1
    WS1 --> WS2 --> WS3
    WS3 -->|"UPSERT"| DB
    DB -->|"SELECT"| RS1
    RS1 --> RS2 --> RS3
    
    BROWSER --> R1 --> R2
    RS3 -->|"WebSocket"| R3 --> R4 --> BROWSER

    style VOTE_SVC fill:#4285f4,stroke:#1a73e8,color:#fff
    style WORKER_SVC fill:#9334e6,stroke:#7627bb,color:#fff
    style RESULT_SVC fill:#34a853,stroke:#1e8e3e,color:#fff
    style REDIS_Q fill:#ea4335,stroke:#c5221f,color:#fff
    style PG_DB fill:#fbbc04,stroke:#f9ab00,color:#1a1a1a
```
DATA
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Stores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Store | Type | Purpose | Data Format |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Redis | In-Memory | Vote Queue | \`{voter_id: string, vote: 'a'\|'b'}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL | Persistent | Vote Storage | \`votes(id VARCHAR, vote VARCHAR)\` |" >> $GITHUB_STEP_SUMMARY

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # KUBERNETES TOPOLOGY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "â˜¸ï¸ Generate Kubernetes Topology"
        if: inputs.diagram_type == 'kubernetes-topology' || inputs.diagram_type == 'all' || github.event.inputs.diagram_type == 'kubernetes-topology' || github.event.inputs.diagram_type == 'all'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â˜¸ï¸ Kubernetes Resource Topology" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ENVS="${{ inputs.environment || github.event.inputs.environment || 'all' }}"
          [ "$ENVS" = "all" ] && ENVS="dev qa"
          
          for ENV in $ENVS; do
            NAMESPACE="voting-app-${ENV}"
            
            echo "### ${ENV^^} Environment (\`${NAMESPACE}\`)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Try to get live data from cluster
            if kubectl get namespace $NAMESPACE &>/dev/null; then
              echo "| Resource Type | Name | Status | Replicas |" >> $GITHUB_STEP_SUMMARY
              echo "|---------------|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
              
              # Deployments
              kubectl get deployments -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| Deployment | \(.metadata.name) | \(.status.conditions[-1].type) | \(.status.readyReplicas // 0)/\(.status.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
              
              # Rollouts
              kubectl get rollouts -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| Rollout | \(.metadata.name) | \(.status.phase // "Unknown") | \(.status.readyReplicas // 0)/\(.spec.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
              
              # StatefulSets
              kubectl get statefulsets -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| StatefulSet | \(.metadata.name) | Ready | \(.status.readyReplicas // 0)/\(.status.replicas // 0) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
              
              # Services
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Services:**" >> $GITHUB_STEP_SUMMARY
              echo "| Service | Type | Port | Selector |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|------|------|----------|" >> $GITHUB_STEP_SUMMARY
              kubectl get svc -n $NAMESPACE -o json 2>/dev/null | \
                jq -r '.items[] | "| \(.metadata.name) | \(.spec.type) | \(.spec.ports[0].port) | \(.spec.selector | to_entries | map("\(.key)=\(.value)") | join(", ")) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            else
              echo "> âš ï¸ Unable to connect to cluster or namespace not found" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ðŸ“‹ Generate Summary"
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Quick Reference" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Environment URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Vote App | Results App |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | [${{ env.DEV_URL }}](${{ env.DEV_URL }}) | [results.dev](https://results.opsera-voting-app-dev.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | [${{ env.QA_URL }}](${{ env.QA_URL }}) | [results.qa](https://results.opsera-voting-app-qa.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Technology Stack" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Technology | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote Service | Python Flask | Web UI for voting |" >> $GITHUB_STEP_SUMMARY
          echo "| Result Service | Node.js Express | Real-time results display |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | .NET Core | Vote processing |" >> $GITHUB_STEP_SUMMARY
          echo "| Queue | Redis | Message broker |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | PostgreSQL | Persistent storage |" >> $GITHUB_STEP_SUMMARY
          echo "| Ingress | NGINX | Traffic routing |" >> $GITHUB_STEP_SUMMARY
          echo "| TLS | cert-manager | SSL certificates |" >> $GITHUB_STEP_SUMMARY
          echo "| GitOps | ArgoCD | Deployment automation |" >> $GITHUB_STEP_SUMMARY
          echo "| Progressive Delivery | Argo Rollouts | Canary deployments |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | New Relic | APM & metrics |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **Tip:** Mermaid diagrams render automatically in GitHub. Click on the workflow summary to view the diagrams." >> $GITHUB_STEP_SUMMARY
