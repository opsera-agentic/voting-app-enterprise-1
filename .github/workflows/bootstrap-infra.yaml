name: "Bootstrap Infrastructure"

on:
  workflow_dispatch:
    inputs:
      tenant:
        description: 'Tenant/organization name'
        required: true
        type: string
        default: 'opsera'
      app_name:
        description: 'Application name'
        required: true
        type: string
        default: 'voting-app'
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'dev'
      region:
        description: 'AWS region'
        required: true
        type: string
        default: 'us-west-2'

env:
  AWS_REGION: ${{ github.event.inputs.region || 'us-west-2' }}
  TENANT: ${{ github.event.inputs.tenant || 'opsera' }}
  APP_NAME: ${{ github.event.inputs.app_name || 'voting-app' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  DOMAIN: agent.opsera.dev
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  id-token: write

jobs:
  # ============================================
  # STAGE 1: Verify Prerequisites
  # ============================================
  verify-prerequisites:
    name: "Verify Prerequisites"
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.subdomain.outputs.subdomain }}
      ecr_uri: ${{ steps.aws.outputs.ecr_uri }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Info
        id: aws
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "AWS Account: ${AWS_ACCOUNT_ID}"
          echo "ECR URI: ${ECR_URI}"

      - name: Verify Hub Cluster Exists
        run: |
          if ! aws eks describe-cluster --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "WARNING: Hub cluster ${{ env.HUB_CLUSTER }} not found"
            echo "Please ensure ArgoCD hub cluster is provisioned first"
          else
            echo "Hub cluster ${{ env.HUB_CLUSTER }} found"
          fi

      - name: Generate Subdomain
        id: subdomain
        run: |
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"
          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "Subdomain: ${SUBDOMAIN}"

      - name: Check DNS Availability
        run: |
          SUBDOMAIN="${{ steps.subdomain.outputs.subdomain }}"

          # Get hosted zone ID
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name "${{ env.DOMAIN }}" \
            --query "HostedZones[?Name=='${{ env.DOMAIN }}.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "WARNING: Hosted zone for ${{ env.DOMAIN }} not found"
            echo "DNS records will need manual configuration"
            exit 0
          fi

          # Check for existing records
          EXISTING_RECORDS=$(aws route53 list-resource-record-sets \
            --hosted-zone-id "$HOSTED_ZONE_ID" \
            --query "ResourceRecordSets[?Name=='${SUBDOMAIN}.']" \
            --output json)

          RECORD_COUNT=$(echo "$EXISTING_RECORDS" | jq 'length')

          if [ "$RECORD_COUNT" -gt 0 ]; then
            echo "WARNING: DNS records already exist for ${SUBDOMAIN}"
            echo "Existing records:"
            echo "$EXISTING_RECORDS" | jq -r '.[] | "\(.Type): \(.Name)"'
          else
            echo "Subdomain ${SUBDOMAIN} is available"
          fi

  # ============================================
  # STAGE 2: Setup ArgoCD Repository Secret
  # ============================================
  setup-argocd:
    name: "Setup ArgoCD"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Hub Cluster
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} || {
            echo "Hub cluster not found. Skipping ArgoCD setup."
            exit 0
          }

          $KUBECTL cluster-info

      - name: Create Repository Secret
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          KUBECTL="./kubectl"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"

          # Skip if no PAT configured
          if [ -z "$GH_PAT" ]; then
            echo "GH_PAT not configured, skipping repository secret creation"
            exit 0
          fi

          # Check if secret exists
          if $KUBECTL get secret repo-${{ env.APP_NAME }} -n argocd 2>/dev/null; then
            echo "Repository secret already exists"
          else
            $KUBECTL create secret generic repo-${{ env.APP_NAME }} \
              -n argocd \
              --from-literal=type=git \
              --from-literal=url="$REPO_URL" \
              --from-literal=password="$GH_PAT" \
              --from-literal=username="git"

            $KUBECTL label secret repo-${{ env.APP_NAME }} -n argocd \
              argocd.argoproj.io/secret-type=repository
          fi

      - name: Apply ArgoCD Application
        run: |
          KUBECTL="./kubectl"
          git pull origin main

          APP_MANIFEST=".opsera-${{ env.APP_NAME }}/argocd/application.yaml"
          if [ -f "$APP_MANIFEST" ]; then
            $KUBECTL apply -f "$APP_MANIFEST"
            echo "ArgoCD Application created/updated"
          fi

  # ============================================
  # STAGE 4: Verify Bootstrap Complete
  # ============================================
  verify-bootstrap:
    name: "Verify Bootstrap Complete"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, setup-argocd]
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify ArgoCD Application
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} || {
            echo "Hub cluster not found"
            exit 0
          }

          APP_NAME="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          # Check if application exists
          if $KUBECTL get application "$APP_NAME" -n argocd 2>/dev/null; then
            echo "ArgoCD Application '$APP_NAME' exists"

            # Get sync status
            SYNC_STATUS=$($KUBECTL get application "$APP_NAME" -n argocd \
              -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")

            echo "Sync Status: $SYNC_STATUS"

            if [ "$SYNC_STATUS" = "Unknown" ]; then
              echo "WARNING: Sync status is Unknown. Check repository access."
            fi
          else
            echo "WARNING: ArgoCD Application '$APP_NAME' not found"
          fi

      - name: Bootstrap Summary
        env:
          SUBDOMAIN: ${{ needs.verify-prerequisites.outputs.subdomain }}
        run: |
          echo "## Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant | ${{ env.TENANT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application | ${{ env.APP_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Subdomain | ${SUBDOMAIN} |" >> $GITHUB_STEP_SUMMARY
          echo "| Hub Cluster | ${{ env.HUB_CLUSTER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke Cluster | ${{ env.SPOKE_CLUSTER }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run CI/CD workflow: \`ci-cd-voting-app.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Run HTTPS setup: \`setup-https-certmanager.yaml\`" >> $GITHUB_STEP_SUMMARY
