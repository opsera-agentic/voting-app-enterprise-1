# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                â•‘
# â•‘              ENTERPRISE CD PIPELINE - DEPLOY TO DEV                            â•‘
# â•‘                                                                                â•‘
# â•‘  Stage 3 of the CI/CD Pipeline:                                                â•‘
# â•‘  â€¢ Jira ticket creation & tracking                                             â•‘
# â•‘  â€¢ Update Kustomize manifests                                                  â•‘
# â•‘  â€¢ Trigger ArgoCD sync                                                         â•‘
# â•‘  â€¢ Validate deployment health                                                  â•‘
# â•‘  â€¢ Run smoke tests                                                             â•‘
# â•‘  â€¢ Generate architecture diagram                                               â•‘
# â•‘  â€¢ Comprehensive deployment report                                             â•‘
# â•‘                                                                                â•‘
# â•‘  Powered by Opsera - The Unified DevOps Platform                               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸš€ CD: Deploy to DEV"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string
  workflow_call:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  ENVIRONMENT: dev
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  DEV_URL: https://opsera-voting-app-dev.agent.opsera.dev
  DEV_RESULTS_URL: https://results.opsera-voting-app-dev.agent.opsera.dev
  # Jira Configuration
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL || 'https://opsera-jira-mock-labs.agent.opsera.dev' }}
  JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY || 'PR1' }}

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JIRA: CREATE DEPLOYMENT TICKET
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  jira-create-ticket:
    name: "ğŸ« Create Jira Ticket"
    runs-on: ubuntu-latest
    outputs:
      ticket_key: ${{ steps.create.outputs.ticket_key }}
      ticket_url: ${{ steps.create.outputs.ticket_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create Deployment Ticket
        id: create
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          echo "## ğŸ« Jira Deployment Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$JIRA_TOKEN" ]; then
            echo "âš ï¸ Jira not configured - using mock ticket" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=MOCK-001" >> $GITHUB_OUTPUT
            echo "ticket_url=${{ env.JIRA_BASE_URL }}/ui" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -1 | sed 's/"/\\"/g' || echo "Deployment")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          DESCRIPTION="ğŸš€ DEV Deployment Started

ğŸ“‹ Deployment Details:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Image Tag: ${IMAGE_TAG}
â€¢ Commit: ${COMMIT_SHA}
â€¢ Branch: ${GITHUB_REF_NAME}
â€¢ Environment: DEV
â€¢ Triggered: ${TIMESTAMP}
â€¢ Triggered By: ${GITHUB_ACTOR}
â€¢ Workflow: ${WORKFLOW_URL}

ğŸ“ Commit Message:
${COMMIT_MSG}

ğŸ”„ Deployment Stages:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ ] Pre-deployment validation
[ ] Update manifests
[ ] ArgoCD sync
[ ] Verify deployment
[ ] Smoke tests
[ ] Generate architecture diagram"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue" \
            -d "{
              \"fields\": {
                \"project\": {\"key\": \"${{ env.JIRA_PROJECT_KEY }}\"},
                \"summary\": \"[Deploy] DEV: ${IMAGE_TAG} - ${{ env.APP_NAME }}\",
                \"description\": \"${DESCRIPTION}\",
                \"issuetype\": {\"name\": \"Task\"},
                \"priority\": {\"name\": \"High\"}
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TICKET_KEY=$(echo "$BODY" | jq -r '.key')
            TICKET_URL="${{ env.JIRA_BASE_URL }}/ui?issue=${TICKET_KEY}"
            
            echo "ticket_key=${TICKET_KEY}" >> $GITHUB_OUTPUT
            echo "ticket_url=${TICKET_URL}" >> $GITHUB_OUTPUT
            
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Ticket | [${TICKET_KEY}](${TICKET_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | \`${IMAGE_TAG}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Failed to create Jira ticket (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
            echo "ticket_key=" >> $GITHUB_OUTPUT
            echo "ticket_url=" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRE-DEPLOYMENT VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pre-deploy-check:
    name: "ğŸ” Pre-Deploy Check"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket]
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Image Exists
        id: check
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          echo "## ğŸ” Pre-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          READY=true
          
          for SERVICE in vote result worker; do
            if aws ecr describe-images --repository-name "$SERVICE" --image-ids imageTag="${IMAGE_TAG}" &>/dev/null; then
              echo "| \`${SERVICE}:${IMAGE_TAG}\` | âœ… Found |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`${SERVICE}:${IMAGE_TAG}\` | âŒ Not Found |" >> $GITHUB_STEP_SUMMARY
              READY=false
            fi
          done
          
          echo "ready=${READY}" >> $GITHUB_OUTPUT
          
          if [ "$READY" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Pre-deployment check failed** - one or more images not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Update Jira - Pre-check Complete
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          STATUS="${{ steps.check.outcome }}"
          [ "$STATUS" = "success" ] && MSG="âœ… Pre-deployment validation passed" || MSG="âŒ Pre-deployment validation failed"
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${MSG}\\n\\nAll container images verified in ECR.\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UPDATE MANIFESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: "ğŸ“ Update Manifests"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, pre-deploy-check]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Kustomization
        id: update
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml"
          
          # Update image references
          sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
          sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"
          
          echo "### ğŸ“ Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "Updated \`${KUSTOMIZE_FILE}\` with tag \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git diff --staged --quiet || git commit -m "chore(dev): deploy ${{ inputs.image_tag }} [skip ci]

Jira: ${{ needs.jira-create-ticket.outputs.ticket_key }}"
          git push origin main || echo "No changes to push"

      - name: Update Jira - Manifests Updated
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"âœ… Kustomize manifests updated\\n\\nImage tag: ${{ inputs.image_tag }}\\nCommit pushed to main branch.\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ARGOCD SYNC
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  argocd-sync:
    name: "ğŸ”„ ArgoCD Sync"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, update-manifests]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Sync ArgoCD Application
        id: sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          APP_NAME="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          
          # Hard refresh
          kubectl patch application "${APP_NAME}" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
          
          sleep 5
          
          # Trigger sync
          kubectl patch application "${APP_NAME}" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}' || true
          
          echo "### ğŸ”„ ArgoCD Sync" >> $GITHUB_STEP_SUMMARY
          echo "Triggered sync for \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - ArgoCD Sync
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"ğŸ”„ ArgoCD sync triggered\\n\\nApplication: ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}\\nCluster: ${{ env.HUB_CLUSTER }}\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFY DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-deployment:
    name: "âœ… Verify Deployment"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, argocd-sync]
    outputs:
      healthy: ${{ steps.verify.outputs.healthy }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Wait for Deployment
        id: verify
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          APP_NAME="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          MAX_ATTEMPTS=30
          
          echo "### âœ… Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            SYNC=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
            
            echo "[$i/$MAX_ATTEMPTS] Sync: ${SYNC}, Health: ${HEALTH}"
            
            if [ "$SYNC" = "Synced" ] && [ "$HEALTH" = "Healthy" ]; then
              echo "| Sync Status | âœ… ${SYNC} |" >> $GITHUB_STEP_SUMMARY
              echo "| Health Status | ğŸŸ¢ ${HEALTH} |" >> $GITHUB_STEP_SUMMARY
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 10
          done
          
          echo "| Sync Status | âš ï¸ ${SYNC} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Status | âš ï¸ ${HEALTH} |" >> $GITHUB_STEP_SUMMARY
          echo "healthy=false" >> $GITHUB_OUTPUT

      - name: Update Jira - Deployment Verified
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          HEALTHY="${{ steps.verify.outputs.healthy }}"
          [ "$HEALTHY" = "true" ] && MSG="âœ… Deployment verified healthy" || MSG="âš ï¸ Deployment health check had issues"
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${MSG}\\n\\nArgoCD application is synced and healthy.\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SMOKE TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  smoke-tests:
    name: "ğŸ§ª Smoke Tests"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, verify-deployment]
    outputs:
      passed: ${{ steps.test.outputs.passed }}
    
    steps:
      - name: Run Smoke Tests
        id: test
        run: |
          echo "### ğŸ§ª Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status | Response |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          
          PASSED=true
          
          # Test Vote App
          VOTE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.DEV_URL }}" --connect-timeout 10 -k || echo "000")
          if [ "$VOTE_STATUS" = "200" ] || [ "$VOTE_STATUS" = "301" ] || [ "$VOTE_STATUS" = "302" ]; then
            echo "| Vote App | âœ… | HTTP ${VOTE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Vote App | âš ï¸ | HTTP ${VOTE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Results App
          RESULT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.DEV_RESULTS_URL }}" --connect-timeout 10 -k || echo "000")
          if [ "$RESULT_STATUS" = "200" ] || [ "$RESULT_STATUS" = "301" ] || [ "$RESULT_STATUS" = "302" ]; then
            echo "| Results App | âœ… | HTTP ${RESULT_STATUS} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Results App | âš ï¸ | HTTP ${RESULT_STATUS} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DEV URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Vote: ${{ env.DEV_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- Results: ${{ env.DEV_RESULTS_URL }}" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - Smoke Tests
        if: always()
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"ğŸ§ª Smoke tests completed\\n\\nEndpoints verified:\\nâ€¢ Vote: ${{ env.DEV_URL }}\\nâ€¢ Results: ${{ env.DEV_RESULTS_URL }}\"}" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ARCHITECTURE DIAGRAM
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-architecture:
    name: "ğŸ—ï¸ Architecture Diagram"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, smoke-tests]
    if: always() && needs.smoke-tests.result != 'cancelled'
    
    steps:
      - name: Generate Architecture Diagram
        run: |
          echo "## ğŸ—ï¸ Deployment Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Architecture - DEV Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'ARCH'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#2c5aa0', 'lineColor': '#5c5c5c', 'secondaryColor': '#f5f5f5', 'tertiaryColor': '#ffffff', 'background': '#ffffff'}}}%%
flowchart TB
    subgraph INTERNET["â˜ï¸ INTERNET"]
        USER["ğŸ‘¤ Users"]
    end

    subgraph AWS["â˜ï¸ AWS CLOUD"]
        subgraph ROUTE53["ğŸŒ Route 53 DNS"]
            DNS["opsera-voting-app-dev.agent.opsera.dev"]
        end
        
        subgraph EKS["âˆ EKS Cluster: opsera-usw2-np"]
            subgraph INGRESS["ğŸ”· Ingress Layer"]
                NGINX["NGINX Ingress Controller\n+ cert-manager TLS"]
            end
            
            subgraph DEV_NS["ğŸ“¦ voting-app-dev namespace"]
                direction TB
                VOTE["ğŸ—³ï¸ Vote Service\nPython Flask\nReplicas: 2"]
                RESULT["ğŸ“Š Result Service\nNode.js Express\nReplicas: 2"]
                WORKER["âš™ï¸ Worker\n.NET Core\nReplicas: 1"]
                REDIS[("ğŸ”´ Redis\nIn-Memory Queue")]
                POSTGRES[("ğŸ˜ PostgreSQL\nPersistent Storage")]
            end
            
            subgraph PLATFORM["ğŸ”§ Platform Services"]
                ARGOCD["ğŸ”„ ArgoCD\nGitOps Controller"]
                EXTDNS["ğŸ“ ExternalDNS\nDNS Automation"]
            end
        end
        
        subgraph ECR["ğŸ“¦ ECR Registry"]
            IMG_VOTE["vote:$TAG"]
            IMG_RESULT["result:$TAG"]
            IMG_WORKER["worker:$TAG"]
        end
    end

    subgraph GITHUB["ğŸ™ GitHub"]
        REPO["ğŸ“‚ Repository"]
        GHA["âš¡ GitHub Actions"]
    end

    subgraph MONITOR["ğŸ“Š Monitoring"]
        NEWRELIC["ğŸ“ˆ New Relic APM"]
        SLACK["ğŸ’¬ Slack"]
        JIRA["ğŸ« Jira"]
    end

    %% Flow with numbers
    USER -->|"1ï¸âƒ£ HTTPS Request"| DNS
    DNS -->|"2ï¸âƒ£ Route"| NGINX
    NGINX -->|"3ï¸âƒ£ /vote"| VOTE
    NGINX -->|"3ï¸âƒ£ /result"| RESULT
    
    VOTE -->|"4ï¸âƒ£ Queue Vote"| REDIS
    WORKER -->|"5ï¸âƒ£ Process"| REDIS
    WORKER -->|"6ï¸âƒ£ Persist"| POSTGRES
    RESULT -->|"7ï¸âƒ£ Query"| POSTGRES
    
    REPO -->|"8ï¸âƒ£ Push"| GHA
    GHA -->|"9ï¸âƒ£ Build & Push"| ECR
    GHA -->|"ğŸ”Ÿ Sync"| ARGOCD
    ARGOCD -->|"1ï¸âƒ£1ï¸âƒ£ Deploy"| DEV_NS
    
    DEV_NS -.->|"Metrics"| NEWRELIC
    GHA -.->|"Notify"| SLACK
    GHA -.->|"Track"| JIRA

    classDef aws fill:#ff9900,stroke:#232f3e,color:#232f3e
    classDef k8s fill:#326ce5,stroke:#fff,color:#fff
    classDef app fill:#4a90d9,stroke:#2c5aa0,color:#fff
    classDef data fill:#3d9970,stroke:#2d7050,color:#fff
    classDef external fill:#6c757d,stroke:#495057,color:#fff
    
    class AWS aws
    class EKS,INGRESS,DEV_NS,PLATFORM k8s
    class VOTE,RESULT,WORKER app
    class REDIS,POSTGRES data
    class USER,GITHUB,MONITOR external
```
ARCH

      - name: Generate Sequence Diagram
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Flow Sequence" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'SEQ'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#2c5aa0', 'lineColor': '#5c5c5c', 'background': '#ffffff', 'actorBkg': '#4a90d9', 'actorTextColor': '#ffffff'}}}%%
sequenceDiagram
    autonumber
    
    participant DEV as ğŸ‘¨â€ğŸ’» Developer
    participant GH as ğŸ™ GitHub
    participant GHA as âš¡ GitHub Actions
    participant JIRA as ğŸ« Jira
    participant ECR as ğŸ“¦ ECR
    participant ARGO as ğŸ”„ ArgoCD
    participant K8S as âˆ Kubernetes
    participant APP as ğŸ—³ï¸ Application
    participant NR as ğŸ“ˆ New Relic
    participant SLACK as ğŸ’¬ Slack

    rect rgb(240, 248, 255)
        Note over DEV,GH: Stage 1: Code Commit
        DEV->>GH: git push (code changes)
        GH->>GHA: Trigger CI/CD Pipeline
    end

    rect rgb(255, 248, 240)
        Note over GHA,JIRA: Stage 2: Pipeline Start
        GHA->>JIRA: Create deployment ticket
        JIRA-->>GHA: Ticket: PR1-XXX
        GHA->>SLACK: ğŸ“¢ Deployment started
    end

    rect rgb(240, 255, 240)
        Note over GHA,ECR: Stage 3: Build & Scan
        GHA->>GHA: Run security scans (SAST, SCA, Secrets)
        GHA->>GHA: Build container images
        GHA->>ECR: Push images (vote, result, worker)
        GHA->>JIRA: ğŸ“ Images pushed to ECR
    end

    rect rgb(248, 240, 255)
        Note over GHA,K8S: Stage 4: GitOps Deploy
        GHA->>GH: Update Kustomize manifests
        GHA->>ARGO: Trigger sync
        ARGO->>GH: Pull latest manifests
        ARGO->>K8S: Apply resources
        GHA->>JIRA: ğŸ“ ArgoCD sync triggered
    end

    rect rgb(255, 255, 240)
        Note over K8S,APP: Stage 5: Deployment
        K8S->>K8S: Rolling update pods
        K8S->>ECR: Pull new images
        K8S->>APP: Start new containers
        APP->>NR: Register APM agent
    end

    rect rgb(240, 255, 248)
        Note over GHA,APP: Stage 6: Verification
        GHA->>ARGO: Check sync status
        ARGO-->>GHA: âœ… Synced & Healthy
        GHA->>APP: Run smoke tests
        APP-->>GHA: âœ… HTTP 200 OK
        GHA->>JIRA: ğŸ“ Deployment verified
    end

    rect rgb(248, 255, 240)
        Note over GHA,SLACK: Stage 7: Completion
        GHA->>JIRA: âœ… Close ticket (Done)
        GHA->>SLACK: âœ… DEV deployment complete
        SLACK-->>DEV: ğŸ”” Notification
    end
```
SEQ

      - name: Generate Data Flow Diagram  
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application Data Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'DATA'
```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#1a1a1a', 'background': '#ffffff'}}}%%
flowchart LR
    subgraph CLIENT["ğŸ‘¤ Client Browser"]
        BROWSER["ğŸŒ Web Browser"]
    end
    
    subgraph VOTING["ğŸ—³ï¸ Voting Flow"]
        direction TB
        V1["1ï¸âƒ£ User visits\nvote.domain.com"]
        V2["2ï¸âƒ£ Selects\nCats or Dogs"]
        V3["3ï¸âƒ£ Submit\nvote"]
    end
    
    subgraph BACKEND["âš™ï¸ Backend Processing"]
        direction TB
        VOTE_SVC["ğŸ Vote Service\n(Flask)"]
        REDIS_Q[("ğŸ”´ Redis Queue\nLPUSH vote")]
        WORKER_SVC["ğŸ”§ Worker\n(.NET)"]
        PG_DB[("ğŸ˜ PostgreSQL\nUPSERT vote")]
    end
    
    subgraph RESULTS["ğŸ“Š Results Display"]
        direction TB
        RESULT_SVC["ğŸ“ˆ Result Service\n(Node.js)"]
        R1["4ï¸âƒ£ Real-time\nWebSocket updates"]
        R2["5ï¸âƒ£ Vote percentages\ndisplayed"]
    end
    
    BROWSER --> V1 --> V2 --> V3
    V3 --> VOTE_SVC
    VOTE_SVC -->|"Queue"| REDIS_Q
    REDIS_Q -->|"RPOP"| WORKER_SVC
    WORKER_SVC -->|"Store"| PG_DB
    PG_DB -->|"SELECT"| RESULT_SVC
    RESULT_SVC --> R1 --> R2
    R2 --> BROWSER
    
    style VOTE_SVC fill:#4a90d9,stroke:#2c5aa0,color:#fff
    style WORKER_SVC fill:#68217a,stroke:#4a1857,color:#fff
    style RESULT_SVC fill:#3c873a,stroke:#2d6a2d,color:#fff
    style REDIS_Q fill:#dc382d,stroke:#a52a20,color:#fff
    style PG_DB fill:#336791,stroke:#264d6d,color:#fff
```
DATA

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOYMENT SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-summary:
    name: "ğŸ“Š Deployment Summary"
    runs-on: ubuntu-latest
    needs: [jira-create-ticket, pre-deploy-check, update-manifests, argocd-sync, verify-deployment, smoke-tests, generate-architecture]
    if: always()
    
    steps:
      - name: Generate Summary
        env:
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          echo "## ğŸš€ DEV Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Jira ticket info
          if [ -n "$TICKET_KEY" ]; then
            echo "### ğŸ« Jira Tracking" >> $GITHUB_STEP_SUMMARY
            echo "**Ticket:** [${TICKET_KEY}](${TICKET_URL})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          [ "${{ needs.jira-create-ticket.result }}" = "success" ] && echo "| ğŸ« Jira Ticket | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ« Jira Ticket | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.pre-deploy-check.result }}" = "success" ] && echo "| ğŸ” Pre-Deploy Check | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ” Pre-Deploy Check | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.update-manifests.result }}" = "success" ] && echo "| ğŸ“ Update Manifests | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ“ Update Manifests | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.argocd-sync.result }}" = "success" ] && echo "| ğŸ”„ ArgoCD Sync | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ”„ ArgoCD Sync | âŒ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.verify-deployment.result }}" = "success" ] && echo "| âœ… Verify Deployment | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| âœ… Verify Deployment | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.smoke-tests.result }}" = "success" ] && echo "| ğŸ§ª Smoke Tests | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ§ª Smoke Tests | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          [ "${{ needs.generate-architecture.result }}" = "success" ] && echo "| ğŸ—ï¸ Architecture Diagram | âœ… |" >> $GITHUB_STEP_SUMMARY || echo "| ğŸ—ï¸ Architecture Diagram | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | DEV |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cluster** | ${{ env.SPOKE_CLUSTER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed At** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote App | [${{ env.DEV_URL }}](${{ env.DEV_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Results App | [${{ env.DEV_RESULTS_URL }}](${{ env.DEV_RESULTS_URL }}) |" >> $GITHUB_STEP_SUMMARY

      - name: Update Jira - Deployment Complete
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
        run: |
          [ -z "$JIRA_TOKEN" ] || [ -z "$TICKET_KEY" ] && exit 0
          
          OVERALL="${{ needs.smoke-tests.result }}"
          [ "$OVERALL" = "success" ] && STATUS="âœ… SUCCESSFUL" || STATUS="âš ï¸ COMPLETED WITH WARNINGS"
          
          COMMENT="ğŸš€ DEV DEPLOYMENT ${STATUS}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ Final Status:
â€¢ Image Tag: ${{ inputs.image_tag }}
â€¢ Environment: DEV  
â€¢ Cluster: ${{ env.SPOKE_CLUSTER }}

ğŸ”— Application URLs:
â€¢ Vote: ${{ env.DEV_URL }}
â€¢ Results: ${{ env.DEV_RESULTS_URL }}

ğŸ“Š Pipeline Results:
â€¢ Pre-check: ${{ needs.pre-deploy-check.result }}
â€¢ Manifests: ${{ needs.update-manifests.result }}
â€¢ ArgoCD: ${{ needs.argocd-sync.result }}
â€¢ Verification: ${{ needs.verify-deployment.result }}
â€¢ Smoke Tests: ${{ needs.smoke-tests.result }}

ğŸ—ï¸ Architecture diagram generated in GitHub Actions summary."
          
          curl -s -X POST \
            -H "X-API-Key: ${JIRA_TOKEN}" \
            -H "Content-Type: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/2/issue/${TICKET_KEY}/comment" \
            -d "{\"body\": \"${COMMENT}\"}" || true

      - name: Notify Slack - DEV Complete
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          TICKET_KEY: ${{ needs.jira-create-ticket.outputs.ticket_key }}
          TICKET_URL: ${{ needs.jira-create-ticket.outputs.ticket_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then exit 0; fi
          
          STATUS="${{ needs.smoke-tests.result }}"
          [ "$STATUS" = "success" ] && EMOJI="âœ…" && COLOR="good" || EMOJI="âš ï¸" && COLOR="warning"
          
          JIRA_BLOCK=""
          if [ -n "$TICKET_KEY" ]; then
            JIRA_BLOCK=',{"type": "section", "text": {"type": "mrkdwn", "text": "ğŸ« *Jira:* <'"${TICKET_URL}"'|'"${TICKET_KEY}"'>"}}'
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"${COLOR}"'",
                "blocks": [
                  {"type": "header", "text": {"type": "plain_text", "text": "'"${EMOJI}"' DEV Deployment Complete", "emoji": true}},
                  {"type": "section", "fields": [
                    {"type": "mrkdwn", "text": "*Image Tag:*\n`'"${{ inputs.image_tag }}"'`"},
                    {"type": "mrkdwn", "text": "*Environment:*\nDEV"}
                  ]}'"${JIRA_BLOCK}"',
                  {"type": "section", "text": {"type": "mrkdwn", "text": "*URLs:*\nâ€¢ <'"${{ env.DEV_URL }}"'|Vote App>\nâ€¢ <'"${{ env.DEV_RESULTS_URL }}"'|Results App>"}},
                  {"type": "context", "elements": [{"type": "mrkdwn", "text": "ğŸ“Š Architecture diagram available in <'"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"'|workflow summary>"}]},
                  {"type": "actions", "elements": [
                    {"type": "button", "text": {"type": "plain_text", "text": "â¬†ï¸ Promote to QA"}, "style": "primary", "url": "${{ github.server_url }}/${{ github.repository }}/actions/workflows/40-cd-promote-qa.yaml"}
                  ]}
                ]
              }]
            }' \
            "$SLACK_WEBHOOK" || true
