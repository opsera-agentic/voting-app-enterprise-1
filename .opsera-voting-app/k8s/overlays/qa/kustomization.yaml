apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: voting-app-qa

namespace: voting-app-qa

resources:
  - ../../base
  # QA: Use Argo Rollouts for canary deployments
  - ../../base/rollouts
  # QA: Use Deployments with emptyDir for db/redis (no EBS CSI driver)
  - db-deployment.yaml
  - redis-deployment.yaml
  # Separate ingress for result app
  - result-ingress.yaml

# Exclude standard Deployments from base (replaced by Rollouts)
# Use modern patches format with explicit targets
patches:
  # Remove StatefulSets (using Deployments with emptyDir for QA)
  - target:
      kind: StatefulSet
      name: db
    patch: |-
      $patch: delete
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: db
  - target:
      kind: StatefulSet
      name: redis
    patch: |-
      $patch: delete
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: redis
  # Exclude NewRelic AnalysisTemplates (use http-health-check instead)
  # These have invalid secretKeyRef in headers which Argo Rollouts doesn't support
  - target:
      kind: AnalysisTemplate
      name: newrelic-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-nrql-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-nrql-analysis
  - target:
      kind: AnalysisTemplate
      name: newrelic-combined-analysis
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: newrelic-combined-analysis
  - target:
      kind: AnalysisTemplate
      name: success-rate
    patch: |-
      $patch: delete
      apiVersion: argoproj.io/v1alpha1
      kind: AnalysisTemplate
      metadata:
        name: success-rate
  # Scale down standard Deployments to 0 (Rollouts will handle traffic)
  - target:
      kind: Deployment
      name: vote
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 0
  - target:
      kind: Deployment
      name: result
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 0
  # Additional patches from files
  - path: patch-rollout-replicas.yaml
  - path: patch-ingress.yaml
  - path: patch-newrelic.yaml

# Use labels transformer to avoid modifying immutable selectors
labels:
  - pairs:
      environment: qa
      deployment-strategy: canary
    includeSelectors: false

images:
  - name: vote
    newName: 792373136340.dkr.ecr.us-west-2.amazonaws.com/vote
    newTag: 7c27be6-20260128000811
  - name: result
    newName: 792373136340.dkr.ecr.us-west-2.amazonaws.com/result
    newTag: 7c27be6-20260128000811
  - name: worker
    newName: 792373136340.dkr.ecr.us-west-2.amazonaws.com/worker
    newTag: 7c27be6-20260128000811
