# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║  NEW RELIC CANARY ANALYSIS TEMPLATE (Job-Based)                               ║
# ║                                                                                ║
# ║  Uses Job provider to properly handle secrets via environment variables.       ║
# ║  This solves the secretKeyRef issue in the web provider.                       ║
# ║                                                                                ║
# ║  Metrics Checked:                                                              ║
# ║  • Error rate from APM (< 5%)                                                  ║
# ║  • Response time / latency (< 500ms)                                           ║
# ║  • Apdex score (>= 0.85)                                                       ║
# ║  • Throughput (informational)                                                  ║
# ║                                                                                ║
# ║  Mock New Relic: https://opsera-nrmock-labs.agent.opsera.dev                   ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: newrelic-job-analysis
  labels:
    app.kubernetes.io/part-of: voting-app
    app.kubernetes.io/component: canary-analysis
spec:
  args:
  - name: app-name
    value: "vote"
  - name: error-threshold
    value: "5"
  - name: latency-threshold
    value: "500"
  - name: apdex-threshold
    value: "0.85"
  - name: nr-api-url
    value: "https://opsera-nrmock-labs.agent.opsera.dev"
  metrics:
  # ════════════════════════════════════════════════════════════════════════════
  # ERROR RATE ANALYSIS
  # Success if error rate < threshold (default 5%)
  # Exit code 0 = success, non-zero = failure
  # ════════════════════════════════════════════════════════════════════════════
  - name: error-rate
    interval: 30s
    count: 5
    failureLimit: 2
    consecutiveErrorLimit: 3
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            spec:
              restartPolicy: Never
              containers:
              - name: newrelic-error-check
                image: curlimages/curl:8.5.0
                env:
                - name: NR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: newrelic-api-key
                      key: api-key
                - name: APP_NAME
                  value: "{{args.app-name}}"
                - name: ERROR_THRESHOLD
                  value: "{{args.error-threshold}}"
                - name: NR_API_URL
                  value: "{{args.nr-api-url}}"
                command: ["/bin/sh", "-c"]
                args:
                - |
                  set -e
                  echo "╔══════════════════════════════════════════════════════════════╗"
                  echo "║  New Relic Error Rate Check                                   ║"
                  echo "╚══════════════════════════════════════════════════════════════╝"
                  echo ""
                  echo "App: $APP_NAME"
                  echo "Threshold: $ERROR_THRESHOLD%"
                  echo ""
                  
                  # Fetch error metrics from New Relic
                  RESPONSE=$(curl -s -k -H "Api-Key: $NR_API_KEY" \
                    "${NR_API_URL}/v2/applications/${APP_NAME}/metrics.json?names[]=Errors/all")
                  
                  echo "Response: $RESPONSE"
                  echo ""
                  
                  # Parse error rate (handle both mock and real NR responses)
                  ERROR_RATE=$(echo "$RESPONSE" | grep -o '"errors_per_minute":[0-9.]*' | cut -d: -f2 || echo "0")
                  
                  # If no error rate found, assume 0 (healthy)
                  if [ -z "$ERROR_RATE" ]; then
                    ERROR_RATE=0
                  fi
                  
                  echo "Error Rate: ${ERROR_RATE}%"
                  echo "Threshold:  ${ERROR_THRESHOLD}%"
                  echo ""
                  
                  # Compare using awk for floating point
                  RESULT=$(awk "BEGIN {print ($ERROR_RATE <= $ERROR_THRESHOLD) ? 0 : 1}")
                  
                  if [ "$RESULT" -eq 0 ]; then
                    echo "✅ PASS: Error rate is within threshold"
                    exit 0
                  else
                    echo "❌ FAIL: Error rate exceeds threshold"
                    exit 1
                  fi

  # ════════════════════════════════════════════════════════════════════════════
  # RESPONSE TIME ANALYSIS
  # Success if avg response time < threshold (default 500ms)
  # ════════════════════════════════════════════════════════════════════════════
  - name: response-time
    interval: 30s
    count: 5
    failureLimit: 3
    consecutiveErrorLimit: 3
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            spec:
              restartPolicy: Never
              containers:
              - name: newrelic-latency-check
                image: curlimages/curl:8.5.0
                env:
                - name: NR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: newrelic-api-key
                      key: api-key
                - name: APP_NAME
                  value: "{{args.app-name}}"
                - name: LATENCY_THRESHOLD
                  value: "{{args.latency-threshold}}"
                - name: NR_API_URL
                  value: "{{args.nr-api-url}}"
                command: ["/bin/sh", "-c"]
                args:
                - |
                  set -e
                  echo "╔══════════════════════════════════════════════════════════════╗"
                  echo "║  New Relic Response Time Check                                ║"
                  echo "╚══════════════════════════════════════════════════════════════╝"
                  echo ""
                  echo "App: $APP_NAME"
                  echo "Threshold: ${LATENCY_THRESHOLD}ms"
                  echo ""
                  
                  # Fetch response time metrics from New Relic
                  RESPONSE=$(curl -s -k -H "Api-Key: $NR_API_KEY" \
                    "${NR_API_URL}/v2/applications/${APP_NAME}/metrics.json?names[]=HttpDispatcher")
                  
                  echo "Response: $RESPONSE"
                  echo ""
                  
                  # Parse average response time
                  LATENCY=$(echo "$RESPONSE" | grep -o '"average_response_time":[0-9.]*' | cut -d: -f2 || echo "0")
                  
                  # If no latency found, assume 0 (healthy)
                  if [ -z "$LATENCY" ]; then
                    LATENCY=0
                  fi
                  
                  echo "Response Time: ${LATENCY}ms"
                  echo "Threshold:     ${LATENCY_THRESHOLD}ms"
                  echo ""
                  
                  # Compare using awk for floating point
                  RESULT=$(awk "BEGIN {print ($LATENCY <= $LATENCY_THRESHOLD) ? 0 : 1}")
                  
                  if [ "$RESULT" -eq 0 ]; then
                    echo "✅ PASS: Response time is within threshold"
                    exit 0
                  else
                    echo "❌ FAIL: Response time exceeds threshold"
                    exit 1
                  fi

  # ════════════════════════════════════════════════════════════════════════════
  # APDEX SCORE ANALYSIS
  # Success if Apdex >= threshold (default 0.85)
  # ════════════════════════════════════════════════════════════════════════════
  - name: apdex-score
    interval: 30s
    count: 5
    failureLimit: 3
    consecutiveErrorLimit: 3
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            spec:
              restartPolicy: Never
              containers:
              - name: newrelic-apdex-check
                image: curlimages/curl:8.5.0
                env:
                - name: NR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: newrelic-api-key
                      key: api-key
                - name: APP_NAME
                  value: "{{args.app-name}}"
                - name: APDEX_THRESHOLD
                  value: "{{args.apdex-threshold}}"
                - name: NR_API_URL
                  value: "{{args.nr-api-url}}"
                command: ["/bin/sh", "-c"]
                args:
                - |
                  set -e
                  echo "╔══════════════════════════════════════════════════════════════╗"
                  echo "║  New Relic Apdex Score Check                                  ║"
                  echo "╚══════════════════════════════════════════════════════════════╝"
                  echo ""
                  echo "App: $APP_NAME"
                  echo "Threshold: >= $APDEX_THRESHOLD"
                  echo ""
                  
                  # Fetch Apdex metrics from New Relic
                  RESPONSE=$(curl -s -k -H "Api-Key: $NR_API_KEY" \
                    "${NR_API_URL}/v2/applications/${APP_NAME}/metrics.json?names[]=Apdex")
                  
                  echo "Response: $RESPONSE"
                  echo ""
                  
                  # Parse Apdex score
                  APDEX=$(echo "$RESPONSE" | grep -o '"score":[0-9.]*' | cut -d: -f2 || echo "1.0")
                  
                  # If no score found, assume 1.0 (perfect)
                  if [ -z "$APDEX" ]; then
                    APDEX="1.0"
                  fi
                  
                  echo "Apdex Score: $APDEX"
                  echo "Threshold:   >= $APDEX_THRESHOLD"
                  echo ""
                  
                  # Compare using awk for floating point
                  RESULT=$(awk "BEGIN {print ($APDEX >= $APDEX_THRESHOLD) ? 0 : 1}")
                  
                  if [ "$RESULT" -eq 0 ]; then
                    echo "✅ PASS: Apdex score meets threshold"
                    exit 0
                  else
                    echo "❌ FAIL: Apdex score below threshold"
                    exit 1
                  fi

  # ════════════════════════════════════════════════════════════════════════════
  # THROUGHPUT CHECK (Informational)
  # Ensures the canary is receiving traffic (>= 0 requests/min)
  # ════════════════════════════════════════════════════════════════════════════
  - name: throughput
    interval: 30s
    count: 5
    failureLimit: 5
    consecutiveErrorLimit: 5
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            spec:
              restartPolicy: Never
              containers:
              - name: newrelic-throughput-check
                image: curlimages/curl:8.5.0
                env:
                - name: NR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: newrelic-api-key
                      key: api-key
                - name: APP_NAME
                  value: "{{args.app-name}}"
                - name: NR_API_URL
                  value: "{{args.nr-api-url}}"
                command: ["/bin/sh", "-c"]
                args:
                - |
                  set -e
                  echo "╔══════════════════════════════════════════════════════════════╗"
                  echo "║  New Relic Throughput Check                                   ║"
                  echo "╚══════════════════════════════════════════════════════════════╝"
                  echo ""
                  echo "App: $APP_NAME"
                  echo ""
                  
                  # Fetch throughput metrics from New Relic
                  RESPONSE=$(curl -s -k -H "Api-Key: $NR_API_KEY" \
                    "${NR_API_URL}/v2/applications/${APP_NAME}/metrics.json?names[]=HttpDispatcher")
                  
                  echo "Response: $RESPONSE"
                  echo ""
                  
                  # Parse throughput (calls per minute)
                  THROUGHPUT=$(echo "$RESPONSE" | grep -o '"calls_per_minute":[0-9.]*' | cut -d: -f2 || echo "0")
                  
                  if [ -z "$THROUGHPUT" ]; then
                    THROUGHPUT=0
                  fi
                  
                  echo "Throughput: ${THROUGHPUT} requests/min"
                  echo ""
                  
                  # Throughput is informational - just log it, always pass
                  echo "✅ INFO: Throughput recorded (informational metric)"
                  exit 0
